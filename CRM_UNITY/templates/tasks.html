<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delegated Tasks Log</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* ... (Existing CSS remains the same) ... */
body {
    font-family: sans-serif;
    background: linear-gradient(to bottom, #d1e2c4, rgb(143, 207, 127));
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    margin: 0;
    box-sizing: border-box;
}
.log-container {
    width: 95%;
    max-width: 1600px;
    margin: 40px auto;
    padding: 20px;
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.log-header {
    border-bottom: 2px solid #aed581;
    padding-bottom: 10px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.log-header h1 {
    margin: 0;
    color: #43a047;
}
#search_input {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 300px;
    font-size: 14px;
}
.task-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}
.task-table th, .task-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    text-align: left;
    font-size: 13px;
    word-wrap: break-word;
}
.task-table th {
    background-color: #1e88e5; 
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer; /* Makes it obvious they are clickable */
    position: relative;
    user-select: none;
}
.task-table th:hover {
    background-color: #1565c0;
}
.task-table th i {
    margin-left: 8px;
    font-size: 0.8em;
    opacity: 0.7;
}
.task-table tr:nth-child(even) { background-color: #e3f2fd; } 
.task-table tr.clickable-row:hover { 
    background-color: #bbdefb;
    cursor: pointer; 
}
.return-button {
    padding: 10px 20px;
    background-color: #81c784;
    border: 1px solid #81c784;
    border-radius: 5px;
    text-decoration: none;
    color: white;
    font-weight: bold;
    transition: 0.3s;
}
.return-button:hover {
    background-color: #66bb6a;
}
</style>
</head>
<body>

    <div class="Dashboard" style="margin-top: 25px; display: flex; gap: 10px;">
        <a href="{% url 'dashboard' %}" class="return-button">Back to Home Screen</a>
    </div>

<div class="log-container">
    <div class="log-header">
        <h1>ðŸ“¨ Delegated Tasks Log</h1>
        <div class="log-controls">
            <input type="text" id="search_input" placeholder="ðŸ” Search all columns..." autofocus>
            <p>Active Delegated Tasks: <strong id="task_count">0</strong></p>
        </div>
    </div>

    {% if delegated_tasks %}
    <table class="task-table" id="main_table">
        <thead>
            <tr>
                <th style="width: 18%;" onclick="sortTable(0)">Subject <i class="fas fa-sort"></i></th>
                <th style="width: 15%;" onclick="sortTable(1)">Email Address <i class="fas fa-sort"></i></th>
                <th style="width: 8%;" onclick="sortTable(2)">MG Code <i class="fas fa-sort"></i></th>
                <th style="width: 12%;" onclick="sortTable(3)">Date Received <i class="fas fa-sort"></i></th>
                <th style="width: 12%;" onclick="sortTable(4)">Delegated Date <i class="fas fa-sort"></i></th>
                <th style="width: 12%;" onclick="sortTable(5)">Category <i class="fas fa-sort"></i></th>
                <th style="width: 15%;" onclick="sortTable(6)">Type <i class="fas fa-sort"></i></th>
            </tr>
        </thead>
        <tbody id="table_body">
            {% for task in delegated_tasks %}
                {% if task.status == 'Delegated' %}
                <tr class="clickable-row" onclick="window.location.href='{% url 'delegate_action' email_id=task.email_id %}';"> 
                    <td title="{{ task.subject }}">{{ task.subject }}</td>
                    <td title="{{ task.sender }}">{{ task.sender }}</td>
                    <td>{{ task.member_group_code|default:"N/A" }}</td>
                    <td data-sort="{{ task.arrival_timestamp|date:'U' }}">
                        {{ task.arrival_timestamp|date:"d M Y H:i" }}
                    </td>
                    <td data-sort="{{ task.delegation_timestamp|date:'U' }}">
                        {{ task.delegation_timestamp|date:"d M Y" }}
                    </td>
                    <td>{{ task.category|default:"N/A" }}</td>
                    <td>{{ task.enquiry_type|default:"N/A" }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>ðŸŽ‰ You have no active delegated tasks at the moment.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search_input');
    const tableBody = document.getElementById('table_body');
    const taskCountDisplay = document.getElementById('task_count');
    
    if (!searchInput || !tableBody) return;

    const rows = tableBody.getElementsByTagName('tr');

    function updateVisibleCount() {
        let visibleCount = 0;
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].style.display !== "none") {
                visibleCount++;
            }
        }
        if (taskCountDisplay) taskCountDisplay.innerText = visibleCount;
    }

    // --- Live Search ---
    searchInput.addEventListener('input', function() {
        const filter = searchInput.value.toLowerCase();
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = Array.from(cells).some(td => td.innerText.toLowerCase().includes(filter));
            rows[i].style.display = found ? "" : "none";
        }
        updateVisibleCount();
    });

    updateVisibleCount();
});

// --- Sorting Logic ---
let sortOrder = {}; // Track direction for each column

function sortTable(n) {
    const table = document.getElementById("main_table");
    const tbody = document.getElementById("table_body");
    const rows = Array.from(tbody.rows);
    
    // Toggle sort order
    sortOrder[n] = !sortOrder[n];
    const isAscending = sortOrder[n];

    rows.sort((rowA, rowB) => {
        let valA = rowA.cells[n].innerText.trim();
        let valB = rowB.cells[n].innerText.trim();

        // Check for special data-sort attribute (used for dates)
        const sortValA = rowA.cells[n].getAttribute('data-sort');
        const sortValB = rowB.cells[n].getAttribute('data-sort');
        
        if (sortValA && sortValB) {
            return isAscending ? sortValA - sortValB : sortValB - sortValA;
        }

        // Default string comparison
        return isAscending 
            ? valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'})
            : valB.localeCompare(valA, undefined, {numeric: true, sensitivity: 'base'});
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update Icons
    const headers = table.querySelectorAll('th i');
    headers.forEach(icon => icon.className = 'fas fa-sort'); // Reset all
    const currentIcon = table.rows[0].cells[n].querySelector('i');
    currentIcon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
}
</script>

</body>
</html>