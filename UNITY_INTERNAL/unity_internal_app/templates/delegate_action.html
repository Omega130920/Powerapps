{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Action Task: {{ task.subject }}</title>
<style>
/* ... (Keep all existing CSS styles here) ... */
body{font-family:sans-serif;margin:0;color:#333;line-height:1.6;background:linear-gradient(to bottom,#d1e2c4,rgb(143,207,127));display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:15px 10px;box-sizing:border-box}
.action-container{max-width:none;width:95%;padding:20px;background-color:#fff;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.2);margin-bottom:10px}
h1{color:#1e88e5;border-bottom:2px solid #81c784;padding-bottom:10px;margin-bottom:15px;font-size:24px}
/* --- MESSAGES STYLES --- */
.messages{list-style:none;padding:10px 15px;margin-bottom:15px;border-radius:6px}
.messages li{font-weight:700}
.messages .success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb}
.messages .error{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.messages .info{background-color:#cce5ff;color:#004085;border:1px solid #b8daff}
/* --- TASK DETAILS DISPLAY --- */
.task-header{background-color:#e3f2fd;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:5px solid #1e88e5;font-size:13px}
.task-header-item strong{display:block;color:#0d47a1;font-size:12px;text-transform:uppercase;margin-bottom:3px}
/* Grid for the new editable metadata form */
.metadata-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px 15px;padding:10px;border:1px solid #ccc;border-radius:8px;margin-bottom:15px;background-color:#f5f5f5}
.metadata-grid .form-group{margin-bottom:0}
/* --- COLLAPSIBLE STYLES --- */
.collapsible-header{cursor:pointer;padding:8px 15px;margin-bottom:0;display:flex;justify-content:space-between;align-items:center;border-radius:4px;transition:background-color .3s ease}
.collapsible-header:hover{filter:brightness(1.05)}
.collapse-icon{font-size:1.2em;font-weight:700;transition:transform .3s ease;margin-left:10px}
.collapsible-header[aria-expanded=true] .collapse-icon{transform:rotate(90deg)}
.collapsible-content{max-height:0;overflow:hidden;transition:max-height .3s ease-in-out}
.collapsible-content.expanded{max-height:2000px;overflow:visible}
/* Base style for collapsible sections */
.collapsible-section{padding:0;border:1px solid #ccc;border-radius:8px;margin-bottom:15px}
.collapsible-section h2{margin:0;font-size:18px}
/* Specific header background colors for visibility */
#metadata-header{background-color:#e3f2fd;border-left:5px solid #1e88e5;border-radius:8px 8px 0 0}
#email-view-header{background-color:#fffde7;border-left:5px solid #ffcc80;border-radius:8px 8px 0 0}
#notes-history-header{background-color:#fffaf5;border-left:5px solid #f7931e;border-radius:8px 8px 0 0}
#add-note-header{background-color:#f0f0f0;border-left:5px solid #555;border-radius:8px 8px 0 0}
#send-email-header{background-color:#fff8e1;border-left:5px solid #f7931e;border-radius:8px 8px 0 0}
#finalize-header{background-color:#d4edda;border-left:5px solid #2e7d32;border-radius:8px 8px 0 0;border-style:dashed}
/* NEW: Restore Section Styles */
#restore-header{background-color:#cce5ff;border-left:5px solid #1a73e8;border-radius:8px 8px 0 0}
/* Re-adjusting existing containers to fit the collapsible pattern */
.form-section,.email-content-box,.notes-history-section{padding:0;border:none;margin-bottom:0;background-color:transparent}
/* Internal padding for content that was lost in the wrapper */
.collapsible-content form,.collapsible-content>div:not(.attachment-list,.action-log-container){padding:10px 15px}
/* --- EMAIL CONTENT BOX --- */
.email-content-box label{font-weight:700;color:#ff9800;font-size:14px;display:block;margin-bottom:5px}
.email-content-box iframe{margin:0 15px;width:calc(100% - 30px);height:300px;min-height:300px;border:1px solid #ccc;border-radius:4px}
/* --- ATTACHMENT LIST STYLES --- */
.attachment-list{margin-top:10px;padding:8px;background-color:#f0fff0;border:1px dashed #c3e6cb;border-radius:4px;margin:10px 15px}
.attachment-list strong{color:#2e7d32;display:block;margin-bottom:5px;font-size:14px}
.attachment-link{display:inline-block;margin-right:20px;color:#1e88e5;text-decoration:underline;font-size:13px}
/* --- HISTORY & NOTES STYLES --- */
.notes-history-section h3{margin-top:0;font-size:15px;color:#555}
.notes-list,.action-log{list-style:none;padding-left:0}
.notes-list li{margin-bottom:8px;padding:8px;background-color:#fffae0;border-left:4px solid #f7931e;border-radius:4px;font-size:13px}
.action-log-container{max-height:250px;overflow-y:auto;border:1px solid #ccc;border-radius:4px;padding:10px;background-color:#f5f5f5}
.action-log li{margin-bottom:6px;padding:6px;border-bottom:1px dotted #ccc;font-size:12px}
.log-timestamp{color:#666;font-size:10px;display:block;margin-top:2px}
.log-user{font-weight:700;color:#0d47a1}
/* Status colors for log entries */
.log-type-note{color:#333}
.log-type-update_metadata{color:#1e88e5;font-weight:700}
.log-type-complete{color:#2e7d32;font-weight:700}
.log-type-send_email{color:#f7931e}
/* NEW: Restore Action Color */
.log-type-restore_to_inbox{color:#1a73e8;font-weight:700}
/* --- FORM STYLES --- */
.form-group{margin-bottom:10px}
.form-group label{display:block;margin-bottom:5px;font-weight:700;color:#555;font-size:13px}
/* UPDATED to include file input */
textarea,input[type=text],select,input[type=file]{width:100%;padding:8px;border:1px solid #aed581;border-radius:4px;box-sizing:border-box;font-size:13px}
textarea{min-height:80px;resize:vertical}
input[type=text],select{min-height:auto;height:35px}
/* --- NEW STYLES FOR RICH TEXT EDITOR AND FILE INPUT --- */
.rich-text-editor{min-height:180px;padding:8px;font-size:13px}
.file-upload-wrapper{margin-top:5px;padding:8px}
/* --- BUTTONS --- */
.btn-update-metadata,.btn-complete,.btn-send-email,.btn-add-note{width:100%;padding:8px 12px;font-size:14px;transition:background-color .3s ease;margin-top:5px}
/* NEW: Restore Button Styles */
.btn-restore-inbox{width:100%;padding:10px 15px;background-color:#1a73e8;color:white;border:none;border-radius:4px;cursor:pointer;font-size:16px;transition:background-color .3s ease;margin-top:10px}
.btn-restore-inbox:hover{background-color:#0d47a1}
.btn-update-metadata{background-color:#1e88e5;color:white;border:none;border-radius:4px;cursor:pointer}
.btn-complete{background-color:#2e7d32;color:white;border:none;border-radius:4px;cursor:pointer}
.btn-send-email{background-color:#ff9800;color:white;border:none;border-radius:4px;cursor:pointer}
.btn-add-note{background-color:#777;color:white;border:none;border-radius:4px;cursor:pointer}
.btn-update-metadata:hover{background-color:#1565c0}
.btn-complete:hover{background-color:#1b5e20}
.btn-send-email:hover{background-color:#e65100}
.btn-add-note:hover{background-color:#333}
.return-button{padding:8px 16px;background-color:#81c784;border:1px solid #81c784;border-radius:5px;text-decoration:none;color:white;cursor:pointer;transition:background-color .3s ease;text-align:center;margin-top:15px;font-size:14px}
/* Custom CSS for hidden/cascading options */
select option.hidden{display:none}

/* Helper for the view info button */
.view-info-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #17a2b8;
    color: white;
    text-decoration: none;
    padding: 0 10px;
    border-radius: 4px;
    transition: background-color 0.2s;
    height: 35px; /* Match input height */
    font-size: 13px;
    white-space: nowrap;
}
.view-info-btn:hover {
    background-color: #138496;
}
</style>
</head>
<body>
    <div class="action-container">
        <h1>üìù Action Delegated Task: {{ task.subject }}</h1>
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        
        {# HIDING RED HIGHLIGHTED SECTION 1: DELEGATED INFO HEADER #}
        <div class="task-header" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                <div class="task-header-item"><strong>Delegated By:</strong> {{ task.delegated_by }}</div>
                <div class="task-header-item"><strong>Delegated Date:</strong> {{ task.received_timestamp|date:"Y-m-d H:i" }}</div>
                <div class="task-header-item"><strong>Delegated To:</strong> {{ task.delegated_to }}</div>
            </div>
        </div>

        {% if task.is_recycled %}
        <div class="collapsible-section" id="restore-section">
            <div class="collapsible-header" id="restore-header" onclick="toggleCollapse('restore-content')" aria-expanded="true">
                <h2 style="color: #1a73e8; margin-top: 0;">Restore Task to Inbox</h2>
                <span class="collapse-icon">‚ñ∂</span>
            </div>
            <div class="collapsible-content expanded form-section" id="restore-content">
                <form method="POST" action="{% url 'delegate_action' email_id=task.email_id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action_type" value="restore_to_inbox">
                    <p style="margin-top: 0; font-size: 13px;">
                        **Warning**: This email is currently in the Recycle Bin. If it was incorrectly classified as non-work related, click the button below to move it **back to the active Inbox queue**.
                    </p>
                    <div class="form-group">
                        <label for="restore_note">Restore Note: *(Optional - Logged as an internal note)*</label>
                        <textarea id="restore_note" name="restore_note" placeholder="E.g., 'Misclassified as junk, requires data entry.'"></textarea>
                    </div>
                    <button type="submit" class="btn-restore-inbox">üì• Send Back to Inbox Queue</button>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="collapsible-section" id="metadata-section">
            <div class="collapsible-header" id="metadata-header" onclick="toggleCollapse('metadata-content')" aria-expanded="true">
                <h2 style="color: #1e88e5; margin-top: 0;">Internal Email Info</h2>
                <span class="collapse-icon">‚ñ∂</span>
            </div>
            <div class="collapsible-content expanded form-section" id="metadata-content">
                <form method="POST" action="{% url 'delegate_action' email_id=task.email_id %}" id="metadata_form">
                    {% csrf_token %}
                    <input type="hidden" name="action_type" value="update_metadata">
                    <div class="metadata-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="form-group">
                            <label for="mip_number">Member Group Code:</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="mip_number" name="mip_number" value="{{ task.mip_number|default:'' }}" placeholder="Enter Member Group Code">
                                {% if task.mip_number %}
                                    <a href="{% url 'unity_information' company_code=task.mip_number %}?source=delegated" 
                                       class="view-info-btn" 
                                       title="View Details for {{ task.mip_number }}"
                                       onclick="saveFormState(event, this.href)">
                                        üëÅÔ∏è View Info
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email_category">Email Type:</label>
                            <select id="email_category" name="email_category">
                                <option value="">-- Select Type --</option>
                                <option value="Schedule">Schedule</option>
                                <option value="Claim">Claim</option>
                                <option value="Query">Query</option>
                                <option value="Bank">Bank</option>
                                <option value="Info Only">Info Only</option>
                                <option value="LPI">LPI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Delegate">Email Status:</label>
                            <select id="Delegate" name="Delegate">
                                <option value="Delegate" {% if not task.type or task.type == 'Delegate' %}selected{% endif %}>Delegated</option>
                                <option value="In Progress" {% if task.type == 'In Progress' %}selected{% endif %}>In Progress</option>
                                <option value="Actioned" {% if task.type == 'Actioned' %}selected{% endif %}>Actioned</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="email_method">Communication:</label>
                            <select id="email_method" name="email_method">
                                <option value="Email" {% if task.method == 'Email' %}selected{% endif %}>Email</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 4 / 5;">
                            <button type="submit" class="btn-update-metadata">üîÑ Update Information</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="collapsible-section" id="email-view-section">
            <div class="collapsible-header" id="email-view-header" onclick="toggleCollapse('email-view-content')" aria-expanded="true">
                <h2 style="color: #ff9800; margin-top: 0;">Original Email Content</h2>
                <span class="collapse-icon">‚ñ∂</span>
            </div>
            <div class="collapsible-content expanded email-content-box" id="email-view-content">
                <div style="padding: 15px 15px 0 15px;">
                    <label>Original Email Content (Sender: {{ task.sender_email }}):</label>
                </div>
                <iframe src="{% url 'get_email_body_html' email_id=task.email_id %}" sandbox style="width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 4px; margin: 0 0 10px 0;"></iframe>
                <p style="margin: 0 15px 10px 15px; font-size: 13px;">*The original content is displayed in a secure iframe to prevent script execution.*</p>
                {% if task.delegated_attachments %}
                <div class="attachment-list">
                    <strong>Attached Documents:</strong>
                    {% for att in task.delegated_attachments %}
                    <a href="{% url 'download_attachment' message_id=task.email_id attachment_id=att.attachmentId %}" target="_blank" class="attachment-link">
                        üìÑ {{ att.filename }} ({{ att.size|filesizeformat }})
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        {# HIDING RED HIGHLIGHTED SECTION 2: TASK HISTORY & INTERNAL NOTES #}
        <div class="collapsible-section" id="notes-history-section" style="display: none;">
            <div class="collapsible-header" id="notes-history-header" onclick="toggleCollapse('notes-history-content')" aria-expanded="true">
                <h2 style="color: #f7931e; margin-top: 0;">Task History & Internal Notes</h2>
                <span class="collapse-icon">‚ñ∂</span>
            </div>
            <div class="collapsible-content expanded notes-history-section" id="notes-history-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 10px 15px;">
                    <div>
                        <h3 style="margin-top: 0; color: #555;">Saved Notes (Internal & Communication Log)</h3>
                        <div class="action-log-container" style="max-height: 250px; padding: 5px;">
                            <ul class="notes-list">
                                {# 1. Display notes from the new unmanaged UnityNotes table (unity_notes_history) #}
                                {% for note in unity_notes_history %}
                                <li style="border-left-color: #555; background-color: #e6ffe6;">
                                    <strong>{{ note.user }}</strong> ({{ note.communication_type|default:"Log" }})
                                    <br>
                                    *Action: {{ note.action_notes|default:"N/A" }}*
                                    <p style="margin: 3px 0 0 0; font-size: 13px;">{{ note.notes }}</p>
                                    <span class="log-timestamp">{{ note.date|date:"Y-m-d H:i:s" }}</span>
                                </li>
                                {# 2. If no notes found in the new table, fallback to the old internal_notes JSON logs (related_notes/task.notes) #}
                                {% empty %}
                                {% for note in related_notes %}
                                <li style="border-left-color: #f7931e;">
                                    <strong>{{ note.user }}:</strong> {{ note.note }} (Summary Log)
                                    <span class="log-timestamp">{{ note.timestamp|default:"N/A" }}</span>
                                </li>
                                {% empty %}
                                <li>No internal notes have been saved yet.</li>
                                {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    </div>-->
                    <div>
                        <h3 style="margin-top: 0; color: #1e88e5;">Action Audit Log (System/User Actions)</h3>
                        <div class="action-log-container" style="max-height: 250px;">
                            <ul class="action-log">
                                {% if action_history %}
                                {% for action in action_history %}
                                <li>
                                    <span class="log-user">{{ action.action_user }}</span>
                                    <span class="log-type-{{ action.action_type|lower|default:'log-type-note' }}">
                                        {% if action.action_type == 'complete' %}
                                        ‚úÖ Marked **Completed** {% elif action.action_type == 'update_metadata' %}
                                        üîÑ **Updated Metadata** {% elif action.action_type == 'send_email' %}
                                        ‚úâÔ∏è Sent Email: "{{ action.related_subject|default:'[No Subject]' }}"
                                        {% elif action.action_type == 'add_note' %}
                                        üíæ Added Note
                                        {% elif action.action_type == 'restore_to_inbox' %}
                                        üì• **Restored to Inbox** {% else %}
                                        {{ action.action_type|default:'General Log' }}
                                        {% endif %}
                                    </span>
                                    <br>
                                    {{ action.note_content|slice:":100" }}...
                                    <span class="log-timestamp">{{ action.action_timestamp|date:"Y-m-d H:i:s" }}</span>
                                </li>
                                {% endfor %}
                                {% else %}
                                <li>No actions recorded for this task yet.</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="collapsible-section" id="add-note-section">
            <div class="collapsible-header" id="add-note-header" onclick="toggleCollapse('add-note-content')" aria-expanded="false">
                <h2 style="color: #555; margin-top: 0;">Add Internal Note</h2>
                <span class="collapse-icon">‚ñ∂</span>
            </div>
            <div class="collapsible-content form-section" id="add-note-content">
                <form method="POST" action="{% url 'delegate_action' email_id=task.email_id %}" id="add_note_form" style="padding: 10px 15px;">
                    {% csrf_token %}
                    <input type="hidden" name="action_type" value="add_note">
                    {# NOTE CONTENT TEXTAREA #}
                    <div class="form-group">
                        <label for="internal_note">Internal Note: *(Mandatory)*</label>
                        <textarea id="internal_note" name="internal_note" placeholder="Add a private note about the task progress or client interaction history. This will be visible in the Notes History section." required></textarea>
                    </div>
                    {# NEW DROPDOWN SECTION START #}
                    <div class="row" style="margin-top: 15px; display: flex; gap: 15px;">
                        <div class="col-md-6" style="flex: 1;">
                            <div class="card card-notes-select" style="background-color: #e6ffe6; padding: 15px; border-radius: 8px;">
                                <label for="id_communication_type_note" style="font-weight: bold; display: block; margin-bottom: 5px; color: #38761d;">Communication Type:</label>
                                <select id="id_communication_type_note" name="communication_type_note" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                                    <option value="" disabled selected>Select Communication Type</option>
                                    <option value="Sent Email">
                                        Sent Outgoing Email
                                    </option>
                                    <option value="Outgoing Call">‚òéÔ∏è Outgoing Call</option>
                                    <option value="Notes Log">üìù Notes Log</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6" style="flex: 1;">
                            <div class="card card-notes-select" style="background-color: #e6ffe6; padding: 15px; border-radius: 8px;">
                                <label for="id_action_notes_note" style="font-weight: bold; display: block; margin-bottom: 5px; color: #38761d;">Action Notes:</label>
                                <select id="id_action_notes_note" name="action_notes_note" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option value="" disabled selected>Select Action Note</option>
                                    <option value="Feedback to Sanlam">Feedback to Sanlam</option>
                                    <option value="Feedback to Employer">Feedback to Employer</option>
                                    <option value="Feedback to Member">Feedback to Member</option>
                                    <option value="Feedback to CBC">Feedback to CBC</option>
                                    <option value="Enquiry to FO">Enquiry to FO</option>
                                    <option value="Enquiry to Sanlam">Enquiry to Sanlam</option>
                                    <option value="Enquiry to Employer">Enquiry to Employer</option>
                                    <option value="Enquiry to CBC">Enquiry to CBC</option>
                                    <option value="Sent to Employer">Sent to Employer</option>
                                    <option value="Sent to Sanlam">Sent to Sanlam</option>
                                    <option value="Sent to CBC">Sent to CBC</option>
                                    <option value="Sent to FO">Sent to FO</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    {# NEW DROPDOWN SECTION END #}
                    <button type="submit" class="btn-add-note">üíæ Save Internal Note</button>
                </form>
            </div>
        </div>

        <div class="collapsible-section" id="send-email-section">
            <div class="collapsible-header" id="send-email-header" onclick="toggleCollapse('send-email-content')" aria-expanded="false">
                <h2 style="color: #f7931e; margin-top: 0;">Send Response Email</h2>
                <span class="collapse-icon">‚ñ∂</span>
            </div>
            <div class="collapsible-content form-section" id="send-email-content">
                <form method="POST" action="{% url 'send_task_email' email_id=task.email_id %}" id="email_response_form" enctype="multipart/form-data" style="padding: 10px 15px;">
                    {% csrf_token %}
                    <input type="hidden" name="action_type" value="send_email">
                    <input type="hidden" name="email_body_reply" id="email_body_reply">
                    {# NEW DROPDOWN SECTION FOR EMAIL LOGGING START #}
                    <div class="row" style="margin-bottom: 15px; display: flex; gap: 15px;">
                        <div class="col-md-6" style="flex: 1;">
                            <div class="card card-notes-select" style="background-color: #fff8e1; padding: 15px; border-radius: 8px;">
                                <label for="id_communication_type_email" style="font-weight: bold; display: block; margin-bottom: 5px; color: #cc7800;">Communication Type:</label>
                                <select id="id_communication_type_email" name="communication_type_email" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                                    <option value="Sent Email" selected>Sent Outgoing Email (Automatic)</option>
                                    <option value="Incoming Call" disabled>üìû Incoming Call</option>
                                    <option value="Outgoing Call" disabled>‚òéÔ∏è Outgoing Call</option>
                                    <option value="Notes Log" disabled>üìù Notes Log</option>
                                    <option value="Teams Meeting" disabled>üìù Teams Meeting</option>
                                </select>
                                <small style="display: block; color: #777; font-size: 11px; margin-top: 5px;">This type is automatically set to log the outgoing email.</small>
                            </div>
                        </div>
                        <div class="col-md-6" style="flex: 1;">
                            <div class="card card-notes-select" style="background-color: #fff8e1; padding: 15px; border-radius: 8px;">
                                <label for="id_action_notes_email" style="font-weight: bold; display: block; margin-bottom: 5px; color: #cc7800;">Action Notes:</label>
                                <select id="id_action_notes_email" name="action_notes_email" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option value="" disabled selected>Select Action Note (Final Destination)</option>
                                    <option value="Feedback to Sanlam">Feedback to Sanlam</option>
                                    <option value="Feedback to Employer">Feedback to Employer</option>
                                    <option value="Feedback to Member">Feedback to Member</option>
                                    <option value="Feedback to CBC">Feedback to CBC</option>
                                    <option value="Enquiry to FO">Enquiry to FO</option>
                                    <option value="Enquiry to Sanlam">Enquiry to Sanlam</option>
                                    <option value="Enquiry to Employer">Enquiry to Employer</option>
                                    <option value="Enquiry to CBC">Enquiry to CBC</option>
                                    <option value="Sent to Employer">Sent to Employer</option>
                                    <option value="Sent to Sanlam">Sent to Sanlam</option>
                                    <option value="Sent to CBC">Sent to CBC</option>
                                    <option value="Sent to FO">Sent to FO</option>
                                </select>
                                <small style="display: block; color: #777; font-size: 11px; margin-top: 5px;">This logs the purpose/recipient of your email response.</small>
                            </div>
                        </div>
                    </div>
                    {# NEW DROPDOWN SECTION FOR EMAIL LOGGING END #}
                    <div class="form-group">
                        <label for="recipient_email">To (Recipient's Email Address):</label>
                        <input type="text" id="recipient_email" name="recipient_email" value="{{ task.sender_email|default:'[Sender Email Unknown]' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="email_subject_reply">Subject:</label>
                        <input type="text" id="email_subject_reply" name="email_subject_reply" value="RE: {{ task.subject|slice:'0:40' }}..." required>
                        <small style="display: block; color: #777; margin-top: 5px; font-size: 11px;">
                            **Unique Reference (MIP/Token):** <span id="display_unique_ref">{{ task.mip_number|default:"NO_REF / (Missing)" }}</span>
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="email_body_editor">Email Body: (Supports pasted images and formatting)</label>
                        <div id="email_body_editor" class="rich-text-editor" contenteditable="true" placeholder="Type your response here.">
                            <p>Dear Client,</p>
                            <p>Regarding your query: "{{ task.subject|default:'[No Subject]' }}",</p>
                            <p>[Type your reply here]</p>
                            <p>Kind regards,</p>
                            <p>Delegation Team</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="attachments">Attach Documents:</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="attachments" name="attachments" multiple>
                            <small style="display: block; color: #777; font-size: 11px;">You can select multiple files here.</small>
                        </div>
                    </div>
                    <button type="submit" class="btn-send-email">‚úâÔ∏è Send Email Response</button>
                </form>
            </div>
        </div>

        <div class="collapsible-section" id="finalize-section" style="border-style: dashed;">
            <div class="collapsible-header" id="finalize-header" onclick="toggleCollapse('finalize-content')" aria-expanded="false">
                <h2 style="color: #2e7d32; margin-top: 0;">Finalize Task</h2>
                <span class="collapse-icon">‚ñ∂</span>
            </div>
            <div class="collapsible-content form-section" id="finalize-content">
                <form method="POST" action="{% url 'delegate_action' email_id=task.email_id %}" id="finalize_form" style="padding: 10px 15px;">
                    {% csrf_token %}
                    <input type="hidden" name="action_type" value="complete">
                    <div class="form-group">
                        <label for="completion_notes">Final Completion Notes / Summary:</label>
                        <textarea id="completion_notes" name="completion_notes" placeholder="Add a final summary of the entire task resolution process here. This will be logged as the final internal note."></textarea>
                    </div>
                    <button type="submit" class="btn-complete">‚úÖ Mark Task as Completed</button>
                </form>
            </div>
        </div>

        <div style="text-align: center;">
            <a href="{% url 'tasks' %}" class="return-button">Return to Dashboard</a>
        </div>
    </div>

    <script>
        function toggleCollapse(contentId){
            const content=document.getElementById(contentId);
            const header=content.previousElementSibling;
            const isExpanded=header.getAttribute('aria-expanded')==='true';
            if(isExpanded){
                content.classList.remove('expanded');
                header.setAttribute('aria-expanded','false');
            }else{
                // Collapse others before expanding the target
                document.querySelectorAll('.collapsible-content.expanded').forEach(item=>{
                    if(item.id!==contentId){
                        item.classList.remove('expanded');
                        item.previousElementSibling.setAttribute('aria-expanded','false')
                    }
                });
                content.classList.add('expanded');
                header.setAttribute('aria-expanded','true')
            }
        }
    </script>
    <script>
        const TASK_ID = "{{ task.email_id }}";
        const SESSION_KEY = `task_form_state_${TASK_ID}`;

        // Elements to track for state saving
        const stateElements = {
            'internal_note': document.getElementById('internal_note'),
            'completion_notes': document.getElementById('completion_notes'),
            'email_body_editor': document.getElementById('email_body_editor'),
            'id_communication_type_note': document.getElementById('id_communication_type_note'),
            'id_action_notes_note': document.getElementById('id_action_notes_note'),
            'id_action_notes_email': document.getElementById('id_action_notes_email'),
            'recipient_email': document.getElementById('recipient_email'),
            'email_subject_reply': document.getElementById('email_subject_reply'),
        };

        function saveFormState(event, url) {
            event.preventDefault(); // Stop default navigation
            
            const state = {};

            // Collect values from tracked elements
            for (const key in stateElements) {
                const element = stateElements[key];
                if (element) {
                    if (key === 'email_body_editor') {
                        // For the contenteditable div, save the innerHTML
                        state[key] = element.innerHTML;
                    } else {
                        state[key] = element.value;
                    }
                }
            }

            // Save the entire state object to session storage
            try {
                sessionStorage.setItem(SESSION_KEY, JSON.stringify(state));
                console.log('Form state saved successfully.');
            } catch (e) {
                console.error('Failed to save form state:', e);
            }

            // Navigate manually after saving state
            window.location.href = url;
        }

        function loadFormState() {
            try {
                const savedState = sessionStorage.getItem(SESSION_KEY);
                if (!savedState) return;

                const state = JSON.parse(savedState);
                let changesApplied = false;

                // Apply values to tracked elements
                for (const key in stateElements) {
                    const element = stateElements[key];
                    if (element && state[key] !== undefined && state[key] !== null) {
                        if (key === 'email_body_editor') {
                            // Restore innerHTML for contenteditable
                            if (state[key].trim() !== '') {
                                element.innerHTML = state[key];
                                changesApplied = true;
                            }
                        } else {
                            // Restore value for inputs/textareas/selects
                            if (state[key].trim() !== '') {
                                element.value = state[key];
                                changesApplied = true;
                            }
                        }
                    }
                }
                
                if (changesApplied) {
                    // Only clear state if something was restored
                    sessionStorage.removeItem(SESSION_KEY);
                    // Alert user that their work was preserved
                    console.log('Restored form data from previous session.');
                }

            } catch (e) {
                console.error('Failed to load form state:', e);
                sessionStorage.removeItem(SESSION_KEY); // Clear potentially corrupt data
            }
        }

        document.addEventListener('DOMContentLoaded',function(){
            loadFormState(); // Attempt to restore state on load
            // Existing DOMContentLoaded logic
            const categorySelect=document.getElementById('email_category');
            const typeSelect=document.getElementById('Delegate'); // Corrected ID from email_type to Delegate
            const subjectInput=document.getElementById('email_subject_reply');
            const emailResponseForm=document.getElementById('email_response_form');
            const emailBodyEditor=document.getElementById('email_body_editor');
            const emailBodyHtmlInput=document.getElementById('email_body_reply');
            // Get current values from the Django context to ensure they are pre-selected
            const currentCategory="{{ task.category }}";
            const currentType="{{ task.type }}";
            const uniqueRef="{{ task.mip_number|default:'' }}";

            // 1. Set values for the new independent dropdowns
            if(currentCategory){categorySelect.value=currentCategory}
            
            if(!currentType){
        ¬† ¬†     typeSelect.value = 'Delegate';
            } else if (currentType) {
        ¬† ¬†     typeSelect.value = currentType;
            }

            // ----------------------------------------------------
            // 2. Unique Reference Prepender for Email Subject
            // ----------------------------------------------------
            if(subjectInput&&uniqueRef){
                const currentSubject=subjectInput.value;
                const newSubject=`[${uniqueRef}] ${currentSubject}`;
                subjectInput.value=newSubject
            }

            // ----------------------------------------------------
            // 3. Rich Text Editor Handler for Email Body
            // ----------------------------------------------------
            if(emailResponseForm){
                emailResponseForm.addEventListener('submit',function(event){
                    if(emailBodyHtmlInput&&emailBodyEditor){
                        const content = emailBodyEditor.innerHTML.trim();
                        if (!content || emailBodyEditor.innerText.trim() === '') {
                             alert('Email body cannot be empty.');
                             event.preventDefault();
                             return;
                        }
                        emailBodyHtmlInput.value=content
                    }
                })
            }
            
            // ----------------------------------------------------
            // 4. Initialize Collapsible Sections (Setting the default state)
            // ----------------------------------------------------
            document.getElementById('metadata-content').classList.add('expanded');
            document.getElementById('metadata-header').setAttribute('aria-expanded','true');
            document.getElementById('email-view-content').classList.add('expanded');
            document.getElementById('email-view-header').setAttribute('aria-expanded','true');

            document.getElementById('add-note-content').classList.remove('expanded');
            document.getElementById('add-note-header').setAttribute('aria-expanded','false');
            document.getElementById('send-email-content').classList.remove('expanded');
            document.getElementById('send-email-header').setAttribute('aria-expanded','false');
            document.getElementById('finalize-content').classList.remove('expanded');
            document.getElementById('finalize-header').setAttribute('aria-expanded','false');
            
            if(document.getElementById('restore-content')){
                document.getElementById('restore-content').classList.add('expanded');
                document.getElementById('restore-header').setAttribute('aria-expanded','true')
            }
        });
    </script>
</body>
</html>