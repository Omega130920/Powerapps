{% load static %}

{% block extra_head %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    /* --- INTEGRATED GLOBAL STYLES --- */
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { 
        font-family: sans-serif; 
        font-size: 14px; 
        background: linear-gradient(to bottom, #d1e2c4, #d1e2c4); 
        color: #333; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
    }
    
    .container { 
        width: 95%; max-width: 98%; height: 90vh; display: flex; flex-direction: column; 
        background-color: #f0fff0; padding: 1.5em; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,.1); 
    }

    /* HEADER & BUTTONS */
    .dashboard-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .dashboard-button { 
        padding: 8px 16px; background-color: #81c784; border: 1px solid #81c784; border-radius: 5px; 
        text-decoration: none; color: white; font-weight: 700; transition: background-color .3s ease; font-size: 13px; cursor: pointer; 
    }
    .dashboard-button:hover { background-color: #66bb6a; color: white; }
    h1 { color: #1b5e20; text-align: center; flex-grow: 1; font-size: 22px; margin: 0; }

    /* SEARCH/FILTER CONTAINER */
    .search-container { 
        display: flex; gap: 10px; margin-bottom: 15px; background: #e8f5e9; padding: 15px; 
        border-radius: 8px; border: 1px solid #c8e6c9; align-items: flex-end; 
    }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-label { font-size: 11px; font-weight: bold; color: #1b5e20; margin-bottom: 2px; }
    .search-input { padding: 8px; border: 1px solid #aed581; border-radius: 4px; font-size: 14px; background: white; }

    /* TABLE STYLES */
    .table-wrapper { overflow-y: auto; flex: 1; border: 1px solid #aed581; border-radius: 4px; background: white; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #aed581; font-size: 13px; word-wrap: break-word; }
    th { background-color: #e6ffe6; color: #1b5e20; font-weight: 700; position: sticky; top: 0; z-index: 10; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #e8f5e9; }

    /* Column Specifics */
    .amount-col { text-align: right; }
    .text-center { text-align: center; }

    /* Status Badges */
    .badge-success { 
        background-color: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 4px; 
        font-weight: 700; border: 1px solid #a5d6a7; display: inline-block; font-size: 0.85em;
    }

    /* ACTION BUTTONS */
    .btn-details { background-color: #1e88e5; color: white; padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: bold; text-decoration: none; }
    .btn-details:hover { background-color: #1565c0; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <a href="{% url 'dashboard' %}" class="dashboard-button">‚Üê Back to Home Screen</a>
        <h1>üåé Section 13A Report</h1>
        <div style="display: flex; gap: 10px;">
            {% if filter_start_date or filter_end_date %}
                {% with download_url=request.GET.urlencode %}
                <a href="{% url 'export_global_history_csv' %}?{{ download_url }}" class="dashboard-button" style="background-color: #217346;">
                    üì• Filtered CSV
                </a>
                {% endwith %}
            {% else %}
                <a href="{% url 'export_global_history_csv' %}" class="dashboard-button" style="background-color: #217346;">
                    üì• Full CSV Export
                </a>
            {% endif %}
        </div>
    </div>

    <form method="GET" action="" class="search-container">
        <div class="filter-group" style="flex: 1;">
            <label for="start_date" class="filter-label">START DATE</label>
            <input type="date" class="search-input" id="start_date" name="start_date" value="{{ filter_start_date }}">
        </div>

        <div class="filter-group" style="flex: 1;">
            <label for="end_date" class="filter-label">END DATE</label>
            <input type="date" class="search-input" id="end_date" name="end_date" value="{{ filter_end_date }}">
        </div>

        <button type="submit" class="dashboard-button">üîç Apply Filter</button>
        <a href="{% url 'export_global_bill_history' %}" class="dashboard-button" style="background-color: #757575;">Clear Filter</a>
    </form>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 12%;">Fiscal Period</th>
                    <th style="width: 12%;">Group Code</th>
                    <th style="width: 25%;">Company Name</th>
                    <th style="width: 15%;" class="amount-col">Schedule Amt (H)</th>
                    <th style="width: 15%;" class="amount-col">Total Settled</th>
                    <th style="width: 10%; text-align: center;">Status</th>
                    <th style="width: 11%; text-align: center;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for record in bill_records %}
                <tr>
                    <td><strong>{{ record.bill.A_CCDatesMonth|date:"Y-m" }}</strong></td>
                    <td>{{ record.bill.C_Company_Code }}</td>
                    <td>{{ record.bill.D_Company_Name }}</td>
                    <td class="amount-col">R {{ record.bill.H_Schedule_Amount|default:"0.00"|floatformat:2 }}</td>
                    <td class="amount-col" style="color: #2e7d32; font-weight: bold;">R {{ record.total_settled|floatformat:2 }}</td>
                    <td class="text-center">
                        <span class="badge-success">{{ record.status_name }}</span>
                    </td>
                    <td class="text-center">
                        <a href="{% url 'settle_bill_report' company_code=record.bill.C_Company_Code bill_id=record.bill.id %}" 
                           class="btn-details">View Report</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                        No reconciled bill records found for the selected period.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}