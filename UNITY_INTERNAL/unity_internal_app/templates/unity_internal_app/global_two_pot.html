{% load static %}

{% block extra_head %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* --- INTEGRATED GLOBAL STYLES --- */
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: sans-serif; font-size: 14px; background: linear-gradient(to bottom, #d1e2c4, #d1e2c4); color: #333; display: flex; justify-content: center; align-items: center; }
    
    .container { 
        width: 95%; max-width: 98%; height: 90vh; display: flex; flex-direction: column; 
        background-color: #f0fff0; padding: 1.5em; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,.1); 
    }

    /* HEADER & BUTTONS */
    .dashboard-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .dashboard-button { 
        padding: 8px 16px; background-color: #81c784; border: 1px solid #81c784; border-radius: 5px; 
        text-decoration: none; color: white; font-weight: 700; transition: background-color .3s ease; font-size: 13px; cursor: pointer; 
    }
    .dashboard-button:hover { background-color: #66bb6a; }
    h1 { color: #1b5e20; text-align: center; flex-grow: 1; font-size: 22px; margin: 0; }

    /* SEARCH/FILTER CONTAINER */
    .search-container { 
        display: flex; gap: 10px; margin-bottom: 15px; background: #e8f5e9; padding: 15px; 
        border-radius: 8px; border: 1px solid #c8e6c9; align-items: flex-end; 
    }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-label { font-size: 11px; font-weight: bold; color: #1b5e20; margin-bottom: 2px; }
    .search-input { padding: 8px; border: 1px solid #aed581; border-radius: 4px; font-size: 14px; background: white; }

    /* TABLE STYLES */
    .table-wrapper { overflow-y: auto; flex: 1; border: 1px solid #aed581; border-radius: 4px; background: white; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #aed581; font-size: 13px; word-wrap: break-word; }
    th { background-color: #e6ffe6; color: #1b5e20; font-weight: 700; position: sticky; top: 0; z-index: 10; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #e8f5e9; }

    /* STATUS BADGES */
    .status-tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: .8em; background-color: #d1c4e9; color: #512da8; }
    .badge-success { background-color: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 4px; font-weight: bold; border: 1px solid #a5d6a7; display: inline-block; }

    /* FORM INPUTS */
    .form-select, .form-input { width: 100%; padding: 6px; border: 1px solid #aed581; border-radius: 4px; background-color: #fff; color: #333; font-size: 13px; box-sizing: border-box; }
    .cancel-btn { background-color: #757575; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .save-info-btn { background-color: #1565c0; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; }

    /* PAGINATION */
    .pagination { display: flex; justify-content: center; gap: 5px; padding-top: 15px; }
    .page-link { padding: 6px 12px; border: 1px solid #81c784; background: white; color: #1b5e20; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .page-link.active { background: #1b5e20; color: white; border-color: #1b5e20; }

    /* EMAIL PREVIEW MODAL */
    .email-preview-modal-content { background: #ffffff; width: 85%; max-width: 900px; margin: 40px auto; padding: 0; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); border: none; overflow: hidden; }
    .email-header-box { background: #f1f3f4; padding: 25px 35px; border-bottom: 1px solid #e0e0e0; }
    .email-header-title { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    .email-header-title h2 { margin: 0; color: #202124; font-size: 1.5rem; border: none; padding: 0; }
    .header-meta-row { display: flex; flex-direction: column; gap: 8px; }
    .header-meta-item { font-size: 0.95rem; color: #5f6368; }
    .header-meta-item strong { color: #202124; width: 80px; display: inline-block; }
    .email-body-container { padding: 40px 50px; background: #ffffff; max-height: 55vh; overflow-y: auto; color: #3c4043; font-size: 1.05rem; line-height: 1.6; all: revert; }
    .preview-footer { padding: 15px 35px; background: #f8f9fa; text-align: right; border-top: 1px solid #eee; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <a href="{% url 'dashboard' %}" class="dashboard-button">Back to Home Screen</a>
        <h1>üí∞ Two-Pot Claims Register</h1>
        <div style="display: flex; gap: 10px;">
            <button type="button" class="dashboard-button" style="background-color: #2e7d32;" onclick="openClaimModal()">‚ûï New Two-Pot</button>
        </div>
    </div>

    <form method="GET" action="" class="search-container">
        <div class="filter-group" style="flex: 2;">
            <label class="filter-label">SEARCH</label>
            <input type="text" name="q" class="search-input" placeholder="MIP Number, Surname, or ID..." value="{{ search_query|default:'' }}">
        </div>
        
        <div class="filter-group">
            <label class="filter-label">FROM</label>
            <input type="date" name="start_date" class="search-input" value="{{ start_date|default:'' }}">
        </div>

        <div class="filter-group">
            <label class="filter-label">TO</label>
            <input type="date" name="end_date" class="search-input" value="{{ end_date|default:'' }}">
        </div>

        <button type="submit" class="dashboard-button">Filter</button>
        <button type="button" class="dashboard-button" style="background-color: #217346;" onclick="triggerExcelExport()">üìä Export Excel</button>
        <a href="{% url 'global_two_pot' %}" class="dashboard-button" style="background-color: #757575;">Reset</a>
    </form>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 8%;">Code</th>
                    <th style="width: 18%;">Member</th>
                    <th style="width: 12%;">MIP Number</th>
                    <th style="width: 12%;">ID Number</th>
                    <th style="width: 15%;">Status</th>
                    <th style="width: 15%;">Created</th>
                    <th style="width: 8%; text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for claim in page_obj %}
                <tr>
                    <td><strong>{{ claim.company_code }}</strong></td>
                    <td>{{ claim.member_surname }}, {{ claim.member_name }}</td>
                    <td>{{ claim.mip_number|default:"-" }}</td>
                    <td>{{ claim.id_number }}</td>
                    <td>
                        <span class="badge-success">{{ claim.claim_status }}</span>
                        {% if claim.linked_email_id %}
                            <span onclick="previewLinkedEmail('{{ claim.id }}')" title="Linked to Email" style="cursor: pointer; font-size: 1.2em; margin-left: 5px;">üìß</span>
                        {% endif %}
                    </td>
                    <td>{{ claim.claim_created_date|date:"Y-m-d" }}</td>
                    <td style="text-align: right;">
                        <button class="dashboard-button" style="padding: 4px 10px; font-size: 11px; background-color: #f7931e; border-color: #f7931e;" 
                            onclick="editClaim(this)" 
                            data-id="{{ claim.id }}"
                            data-company_code="{{ claim.company_code }}"
                            data-agent="{{ claim.agent|default:'' }}"
                            data-id_number="{{ claim.id_number }}"
                            data-member_name="{{ claim.member_name }}"
                            data-member_surname="{{ claim.member_surname }}"
                            data-mip_number="{{ claim.mip_number|default:'' }}"
                            data-claim_type="{{ claim.claim_type }}"
                            data-claim_status="{{ claim.claim_status }}"
                            data-claim_allocation="{{ claim.claim_allocation }}"
                            data-payment_option="{{ claim.payment_option }}"
                            data-claim_amount="{{ claim.claim_amount|default:'' }}"
                            data-claim_created_date="{{ claim.claim_created_date|date:'Y-m-d' }}"
                            data-linked_email_id="{{ claim.linked_email_id|default:'' }}"
                        >Edit</button>

                        <template id="notes-data-{{ claim.id }}">
                            {% for note in claim.notes.all %}
                                <tr>
                                    <td>{{ note.note_description }}</td>
                                    <td>{{ note.note_selection }}</td>
                                    <td>{{ note.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ note.created_by.username }}</td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="4" style="text-align:center; color:#777;">No notes found.</td></tr>
                            {% endfor %}
                        </template>

                        {% if claim.linked_email_id %}
                        <template id="email-content-{{ claim.id }}">
                            <div class="p-sender">{{ claim.email_preview_sender|default:"Unknown" }}</div>
                            <div class="p-subject">{{ claim.email_preview_subject|default:"(No Subject)" }}</div>
                            <div class="p-date">{{ claim.email_preview_date|date:"Y-m-d H:i" }}</div>
                            <div class="p-body">{{ claim.email_preview_body|safe }}</div>
                        </template>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" style="text-align: center; padding: 20px;">No Two-Pot claims found matching criteria.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}" class="page-link">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}" class="page-link">Previous</a>
        {% endif %}

        <span class="page-link active">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}" class="page-link">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}" class="page-link">Last &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="claimModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; width: 90%; max-width: 1000px; margin: 30px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
        <h2 id="modalTitle" style="color: #1b5e20; border-bottom: 2px solid #aed581; padding-bottom: 10px;">Manage Two-Pot Claim</h2>
        
        <form id="main_claim_form" method="POST" action="{% url 'save_global_claim' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="claim_id" id="modal_claim_id">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="font-weight:bold;">Company Code *</label>
                    <input list="company_list" name="company_code" id="company_code_input" class="form-input" required placeholder="Search Company...">
                    <datalist id="company_list">
                        {% for c in all_companies %}
                            <option value="{{ c.a_company_code }}" data-agent="{{ c.c_agent }}">{{ c.a_company_code }} - {{ c.b_company_name }}</option>
                        {% endfor %}
                    </datalist>
                </div>
                <div><label style="font-weight:bold;">Agent</label><input type="text" name="agent" id="agent_input" class="form-input" readonly style="background-color: #eee;"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div><label style="font-weight:bold;">ID / Passport *</label><input type="text" name="id_number" class="form-input" required></div>
                <div><label style="font-weight:bold; color:#d32f2f;">MIP Number *</label><input type="text" name="mip_number" class="form-input" required></div>
                <div><label style="font-weight:bold;">First Name *</label><input type="text" name="member_name" class="form-input" required></div>
                <div><label style="font-weight:bold;">Surname *</label><input type="text" name="member_surname" class="form-input" required></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="font-weight:bold;">Claim Type</label>
                    <select name="claim_type" id="claim_type_select" class="form-select">
                        <option value="Two Pot" selected>Two Pot</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight:bold;">Amount (R) (Optional)</label>
                    <input type="number" step="0.01" name="claim_amount" class="form-input" placeholder="0.00">
                </div>
                <div>
                    <label style="font-weight:bold;">Allocation</label>
                    <select name="claim_allocation" class="form-select">
                        <option value="New Claim">New Claim</option>
                        <option value="Claim Paid">Claim Paid</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="font-weight:bold;">Claim Status</label>
                    <select name="claim_status" id="claim_status_select" class="form-select" onchange="toggleWithdrawalSubFields()">
                        <option value="Member Emergency Savings Pot Withdrawal Submitted">Member Emergency Savings Pot Withdrawal Submitted </option>
                        <option value="Member Emergency Savings Pot Withdrawal Requested">Member Emergency Savings Pot Withdrawal Requested </option>
                        <option value="Withdraw - Not Allowed">Withdraw - Not Allowed</option>
                    </select>
                </div>
                
                <div>
                    <label style="font-weight:bold;">Payment Option</label>
                    <select name="payment_option" id="payment_option_select" class="form-select">
                        <option value="Full Payment">Full Payment</option>
                        <option value="Partially Taken">Partially Taken</option>
                        <option value="No Payment Instruction">No Payment Instruction</option>
                    </select>
                </div>
            </div>

            <div id="div_two_pot_withdrawal_details" style="display:none; margin-bottom: 15px; padding: 15px; background: #fffde7; border: 1px solid #fbc02d; border-radius: 5px;">
                <label style="font-weight:bold; color: #bc5100;">Note Generator Helper</label>
                <select id="two_pot_withdrawal_status" class="form-select" onchange="handleWithdrawalStatusChange()">
                    <option value="">-- Select Note Template --</option>
                    <option value="Withdrawal - Not Allowed">Insufficient Funds</option>
                    <option value="Withdrawal - Already claim in current financial year">Already Claimed this Year</option>
                </select>
                <div id="div_prev_claim_date" style="display:none; margin-top: 10px;">
                    <label>Member Previous Claim Date:</label>
                    <input type="date" id="prev_claim_date_input" class="form-input" onchange="handleWithdrawalStatusChange()">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div><label style="font-weight:bold;">Created *</label><input type="date" name="claim_created_date" class="form-input" required value="{% now 'Y-m-d' %}"></div>
            </div>

            <div class="row" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px; margin-bottom: 15px;">
                <div class="col-md-12">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px;">
                        <label for="linked_email_id" style="font-weight: bold; color: #1e88e5;">üîó Attach Delegated Email (Optional)</label>
                        <button type="button" onclick="toggleEmailForm()" style="background-color: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">‚úâÔ∏è Compose Email</button>
                    </div>
                    
                    <select id="linked_email_id" name="linked_email_id" class="form-select" style="border: 1px solid #1e88e5; width: 100%;">
                        <option value="">-- Select an email to link to this claim --</option>
                        {% for email in my_delegated_emails %}
                            <option value="{{ email.id }}">üìÖ {{ email.received_at|date:"Y-m-d" }} | ‚úâÔ∏è {{ email.subject|slice:":40" }}... (From: {{ email.sender }})</option>
                        {% endfor %}
                    </select>

                    <div id="email-composition-container" style="display: none; margin-top: 15px; background-color: #fffaf5; border: 2px dashed #ff9800; border-radius: 8px; padding: 20px;">
                        <h3 style="color: #ff9800; margin-top: 0; font-size: 16px;">Compose Outgoing Email</h3>
                        <textarea id="email_body_html_content" name="email_body_html_content" style="display:none;"></textarea>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">To:</label>
                            <input type="text" id="member_recipient_email" name="member_recipient_email" placeholder="Enter email addresses..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Subject:</label>
                            <input type="text" id="member_email_subject_reply" name="member_email_subject_reply" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Email Body:</label>
                            <textarea id="member_email_body_editor" class="form-input" rows="6" style="width: 100%;">Dear Sir/Madam,&#10;&#10;Kind regards,&#10;{{ request.user.username }}</textarea>
                        </div>
                        <div style="text-align: right;">
                            <button type="button" class="cancel-btn" onclick="toggleEmailForm()" style="font-size: 12px; margin-right: 10px;">Hide Email Form</button>
                            <button type="submit" name="email_submission_action" value="send_email_and_log" style="padding: 8px 15px; background-color: #f7931e; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Send Email & Save Claim</button>
                        </div>
                    </div>
                </div>
            </div>

            <label style="font-weight:bold;">Note Description</label>
            <textarea name="note_description" id="note_description" rows="3" class="form-input" style="width: 100%; margin-bottom: 15px;"></textarea>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Claim Attachment (File)</label>
                <input type="file" name="claim_attachment" class="form-input">
            </div>

            <h3 style="color: #38761d; margin-top: 20px;">Claim Notes History</h3>
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd;">
                <table style="margin: 0; font-size: 12px; width:100%;">
                    <thead style="background-color: #eee;"><tr><th>Note</th><th>Type</th><th>Date</th><th>User</th></tr></thead>
                    <tbody id="claim_notes_tbody"></tbody>
                </table>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="cancel-btn" onclick="document.getElementById('claimModal').style.display='none'">Cancel</button>
                <button type="submit" class="save-info-btn">Save Claim Only</button>
            </div>
        </form>
    </div>
</div>

<div id="emailPreviewModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 2000;">
    <div class="email-preview-modal-content">
        <div class="email-header-box">
            <div class="email-header-title">
                <span style="font-size: 1.6rem;">‚úâÔ∏è</span>
                <h2>Linked Email Details</h2>
            </div>
            <div class="header-meta-row">
                <div class="header-meta-item"><strong>From:</strong> <span id="pv_from"></span></div>
                <div class="header-meta-item"><strong>Subject:</strong> <span id="pv_subject"></span></div>
                <div class="header-meta-item"><strong>Date:</strong> <span id="pv_date"></span></div>
            </div>
        </div>
        <div id="pv_body" class="email-body-container"></div>
        <div class="preview-footer">
            <button type="button" class="cancel-btn" style="background: #5f6368; padding: 10px 25px;" onclick="document.getElementById('emailPreviewModal').style.display='none'">Close Preview</button>
        </div>
    </div>
</div>

<script>
    function openClaimModal() {
        const modal = document.getElementById('claimModal');
        modal.querySelector('form').reset();
        document.getElementById('modal_claim_id').value = '';
        document.getElementById('modalTitle').innerText = "New Two-Pot Entry";
        document.getElementById('claim_notes_tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;">New entry.</td></tr>';
        document.getElementById('claim_type_select').value = "Two Pot"; 
        const emailSelect = document.getElementById('linked_email_id');
        if(emailSelect) emailSelect.value = "";
        document.getElementById('email-composition-container').style.display = 'none';
        modal.style.display = 'block';
    }

    function editClaim(btn) {
        const claimId = btn.dataset.id;
        document.getElementById('modalTitle').innerText = "Edit Two-Pot Claim";
        document.getElementById('modal_claim_id').value = claimId;
        document.getElementById('company_code_input').value = btn.dataset.company_code;
        document.getElementById('agent_input').value = btn.dataset.agent;
        document.querySelector('input[name="id_number"]').value = btn.dataset.id_number;
        document.querySelector('input[name="member_name"]').value = btn.dataset.member_name;
        document.querySelector('input[name="member_surname"]').value = btn.dataset.member_surname;
        document.querySelector('input[name="mip_number"]').value = btn.dataset.mip_number;
        const statusSel = document.getElementById('claim_status_select');
        statusSel.value = btn.dataset.claim_status;
        document.querySelector('select[name="claim_allocation"]').value = btn.dataset.claim_allocation;
        document.querySelector('select[name="payment_option"]').value = btn.dataset.payment_option;
        document.querySelector('input[name="claim_amount"]').value = btn.dataset.claim_amount;
        document.querySelector('input[name="claim_created_date"]').value = btn.dataset.claim_created_date;
        document.getElementById('claim_type_select').value = "Two Pot";
        const emailSelect = document.getElementById('linked_email_id');
        if(emailSelect) emailSelect.value = btn.dataset.linked_email_id || "";
        document.getElementById('email-composition-container').style.display = 'none';
        const notesSrc = document.getElementById('notes-data-' + claimId);
        const notesTrg = document.getElementById('claim_notes_tbody');
        if (notesSrc && notesTrg) {
            const content = notesSrc.content.cloneNode(true);
            const rows = content.querySelectorAll('tr');
            rows.forEach(row => {
                const noteCell = row.cells[0]; 
                if (noteCell && noteCell.innerText.includes("Linked to Delegated Email ID #")) {
                    const viewBtn = document.createElement('button');
                    viewBtn.type = "button";
                    viewBtn.innerText = "View Email";
                    viewBtn.className = "btn-view-inline";
                    viewBtn.onclick = function() { previewLinkedEmail(claimId); };
                    noteCell.appendChild(viewBtn);
                }
            });
            notesTrg.innerHTML = ""; 
            notesTrg.appendChild(content);
        }
        toggleWithdrawalSubFields();
        document.getElementById('claimModal').style.display = 'block';
    }

    function previewLinkedEmail(claimId) {
        const template = document.getElementById('email-content-' + claimId);
        if (!template) { alert("No email content found."); return; }
        const sender = template.content.querySelector('.p-sender').innerText;
        const subject = template.content.querySelector('.p-subject').innerText;
        const date = template.content.querySelector('.p-date').innerText;
        const body = template.content.querySelector('.p-body').innerHTML;
        document.getElementById('pv_from').innerText = sender;
        document.getElementById('pv_subject').innerText = subject;
        document.getElementById('pv_date').innerText = date;
        document.getElementById('pv_body').innerHTML = body;
        document.getElementById('emailPreviewModal').style.display = 'block';
    }

    function triggerExcelExport() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') || '';
        const start = urlParams.get('start_date') || '';
        const end = urlParams.get('end_date') || '';
        let exportUrl = "{% url 'export_two_pot_excel' %}?q=" + encodeURIComponent(query) + "&start_date=" + start + "&end_date=" + end;
        window.location.href = exportUrl;
    }

    function toggleEmailForm() {
        const container = document.getElementById('email-composition-container');
        const isHidden = container.style.display === 'none';
        container.style.display = isHidden ? 'block' : 'none';
        if(isHidden) {
            const company = document.getElementById('company_code_input').value || "UNKNOWN";
            const subjectField = document.getElementById('member_email_subject_reply');
            if(!subjectField.value || subjectField.value.trim() === "") {
                subjectField.value = `[Two-Pot: ${company}] Withdrawal Update`;
            }
        }
    }

    document.getElementById('main_claim_form').addEventListener('submit', function() {
        const bodyText = document.getElementById('member_email_body_editor').value;
        document.getElementById('email_body_html_content').value = bodyText;
    });

    function toggleWithdrawalSubFields() {
        const status = document.getElementById('claim_status_select').value;
        const helper = document.getElementById('div_two_pot_withdrawal_details');
        helper.style.display = (status === "Withdraw - Not Allowed") ? 'block' : 'none';
        if (status === "Withdraw - Not Allowed") {
            document.getElementById('two_pot_withdrawal_status').value = "Withdrawal - Not Allowed";
        }
        handleWithdrawalStatusChange();
    }

    function handleWithdrawalStatusChange() {
        const reason = document.getElementById('two_pot_withdrawal_status').value;
        const dateDiv = document.getElementById('div_prev_claim_date');
        const note = document.getElementById('note_description');
        if (reason !== "") { document.getElementById('div_two_pot_withdrawal_details').style.display = 'block'; }
        if (reason === "Withdrawal - Not Allowed") {
            dateDiv.style.display = 'none';
            note.value = "Withdrawal\n- Not Allowed - Not enough funds available";
        } else if (reason.includes("Already claim")) {
            dateDiv.style.display = 'block';
            const date = document.getElementById('prev_claim_date_input').value;
            note.value = `Withdrawal - Already claim in current financial year - Member claim date = ${date || '(Select Date)'} - Next Financial Year starting (01 March - End of February)`;
        }
    }

    document.getElementById('company_code_input').addEventListener('input', function() {
        let val = this.value;
        let opts = document.getElementById('company_list').childNodes;
        for (let i = 0; i < opts.length; i++) {
            if (opts[i].value === val) {
                document.getElementById('agent_input').value = opts[i].getAttribute('data-agent') || '';
                break;
            }
        }
    });

    window.onclick = function(event) {
        const epModal = document.getElementById('emailPreviewModal');
        const cModal = document.getElementById('claimModal');
        if (event.target == epModal) epModal.style.display = "none";
        if (event.target == cModal) cModal.style.display = "none";
    }
</script>
{% endblock %}