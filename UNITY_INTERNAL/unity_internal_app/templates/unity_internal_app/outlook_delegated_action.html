{% load static %}

{% block title %}Task #{{ delegation.pk }}: {{ email.subject|default:"(No Subject)" }}{% endblock %}

{% block content %}
<style>
    /* ... (Your existing styles remain unchanged) ... */
    body { font-family: sans-serif; background: linear-gradient(to bottom, #d1e2c4, rgb(143, 207, 127)); display: flex; flex-direction: column; justify-content: flex-start; align-items: center; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; }
    .task-container { width: 100%; max-width: 1200px; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); padding: 30px; }
    .main-grid { display: flex; flex-wrap: wrap; gap: 20px; }
    .left-column { flex: 2; min-width: 300px; }
    .right-column { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }
    .custom-card { border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); overflow: hidden; margin-bottom: 5px; }
    .card-header-primary { background-color:  rgb(105, 187, 85); color: white; padding: 15px; font-weight: bold; display: flex; align-items: center; }
    .card-header-dark { background-color: #343a40; color: white; padding: 15px; font-weight: bold; display: flex; align-items: center; }
    .card-body-content { padding: 20px; }
    .task-header h1 { font-size: 28px; margin-bottom: 5px; color: #333; }
    .task-header .status-badge { display: inline-block; padding: 5px 12px; border-radius: 50px; font-weight: bold; font-size: 14px; margin-left: 10px; }
    .badge-dlt { background-color: #d32f2f; color: white; }
    .badge-com { background-color: #28a745; color: white; }
    .badge-default { background-color: #ffc107; color: #212529; }
    .form-label { font-weight: bold; display: block; margin-bottom: 5px; margin-top: 10px; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
    .notes-history-container { border: 1px solid #eee; background-color: #f8f9fa; padding: 10px; max-height: 380px; overflow-y: auto; border-radius: 4px; margin-bottom: 20px; }
    .note-item { border-left: 5px solid #28a745; padding: 10px; background: #ffffff; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); border-radius: 0 4px 4px 0; }
    .collapse-toggle { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; background: #f8f9fa; border: none; text-align: left; font-size: 16px; font-weight: bold; cursor: pointer; border-bottom: 3px solid  rgb(105, 187, 85); color: #333; }
    .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .collapse-content.show { max-height: 1000px; padding: 20px; }
    .custom-btn { padding: 12px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; width: 100%; box-sizing: border-box; }
    .btn-primary { background-color:  rgb(105, 187, 85); color: white; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-update-metadata { background-color:  rgb(105, 187, 85); color: white; }
    .btn-back { background-color: white; color: #343a40; border: 1px solid #343a40; }
    .btn-restore { background-color: #d32f2f; color: white; width: 100%; font-size: 18px; padding: 15px; margin-bottom: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; gap: 12px; }

    /* --- ATTACHMENT SPECIFIC STYLES --- */
    .attachment-section {
        margin-top: 15px;
        padding: 15px;
        background-color: #f1f8e9;
        border-top: 1px solid #c5e1a5;
    }
    .attachment-pill {
        display: inline-flex;
        align-items: center;
        background: #fff;
        padding: 6px 12px;
        border: 1px solid #aed581;
        border-radius: 20px;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 13px;
        text-decoration: none;
        color: #333;
        transition: all 0.2s;
    }
    .attachment-pill:hover {
        background-color: #e8f5e9;
        border-color: #43a047;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .attachment-pill i { color: #43a047; margin-right: 8px; }
</style>

<div class="task-container">
    <div class="task-header">
        <h1><i class="fas fa-tasks"></i> Task Action: # {{ email.subject }}</h1>
        <p>
            Status: 
            <span class="status-badge 
                {% if delegation.status == 'DLT' %}badge-dlt
                {% elif delegation.status == 'COM' %}badge-com
                {% else %}badge-default{% endif %}">
                {{ delegation.get_status_display }}
            </span>
        </p>
        <hr style="border-top: 1px solid #eee; margin-bottom: 25px;">
    </div>

    {% if messages %}
        <div class="message-area">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert" style="padding: 10px; border-radius: 4px; background: #fff3cd; border: 1px solid #ffeeba; margin-bottom: 10px;">
                {{ message }}
            </div>
        {% endfor %}
        </div>
    {% endif %}

    {# --- RESTORE BUTTON --- #}
    {% if delegation.status == 'DLT' %}
    <form method="POST" action="{% url 'outlook_delegated_action' delegation_id=delegation.pk %}">
        {% csrf_token %}
        <input type="hidden" name="action_type" value="restore_to_inbox">
        <button type="submit" class="btn-restore">
            <i class="fas fa-undo"></i> RESTORE TO MAIN INBOX QUEUE
        </button>
    </form>
    {% endif %}

    <div class="custom-card">
        <div class="card-header-dark" style="background-color:  rgb(105, 187, 85)">
            <i class="fas fa-info-circle" style="margin-right: 10px;"></i>
            <h5 style="margin: 0;">Internal Email Info</h5>
        </div>
        <div class="card-body-content">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="update_metadata">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                    <div class="form-group">
                        <label for="company_code" class="form-label">Member Group Code:</label>
                        <input type="text" id="company_code" name="company_code" value="{{ delegation.company_code|default:'' }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="email_category" class="form-label">Email Type:</label>
                        <select id="email_category" name="email_category" class="form-control">
                            <option value="">-- Select Type --</option>
                            <option value="Schedule" {% if delegation.email_category == 'Schedule' %}selected{% endif %}>Schedule</option>
                            <option value="Claim" {% if delegation.email_category == 'Claim' %}selected{% endif %}>Claim</option>
                            <option value="Query" {% if delegation.email_category == 'Query' %}selected{% endif %}>Query</option>
                            <option value="Bank" {% if delegation.email_category == 'Bank' %}selected{% endif %}>Bank</option>
                            <option value="Info Only" {% if delegation.email_category == 'Info Only' %}selected{% endif %}>Info Only</option>
                            <option value="LPI" {% if delegation.email_category == 'LPI' %}selected{% endif %}>LPI</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status" class="form-label">Email Status:</label>
                        <select id="status" name="status" class="form-control">
                            <option value="DEL" {% if delegation.status == 'DEL' %}selected{% endif %}>Delegated</option>
                            <option value="NEW" {% if delegation.status == 'NEW' %}selected{% endif %}>New / In Progress</option>
                            <option value="COM" {% if delegation.status == 'COM' %}selected{% endif %}>Completed / Actioned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="custom-btn btn-update-metadata">
                            <i class="fas fa-sync-alt"></i> Update Info
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

<div class="custom-card">
        <div class="card-header-dark" style="background-color: rgb(105, 187, 85)">
            <i class="fas fa-info-circle" style="margin-right: 10px;"></i>
            <h5 style="margin: 0;">Email Information</h5>
        </div>
        <div class="card-body-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div class="info-group">
                    <span class="form-label" style="margin-top: 0;">Subject:</span>
                    <div class="form-control" style="background-color: #f8f9fa; border: 1px solid #eee; min-height: 40px; display: flex; align-items: center;">
                        {{ email.subject|default:"(No Subject)" }}
                    </div>
                </div>
                <div class="info-group">
                    <span class="form-label" style="margin-top: 0;">Date Received:</span>
                    <div class="form-control" style="background-color: #f8f9fa; border: 1px solid #eee; min-height: 40px; display: flex; align-items: center;">
                        {{ local_inbox.received_at|date:"M. d, Y, g:i a"|default:delegation.received_at }}
                    </div>
                </div>
                <div class="info-group">
                    <span class="form-label" style="margin-top: 0;">From Email Address:</span>
                    <div class="form-control" style="background-color: #f8f9fa; border: 1px solid #eee; min-height: 40px; display: flex; align-items: center; color: #2e7d32; font-weight: bold;">
                        {{ local_inbox.sender_address|default:email.from.emailAddress.address }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-grid">
        <div class="left-column">
            <div class="custom-card">
                <div class="card-header-primary">
                    <i class="fas fa-inbox" style="margin-right: 10px;"></i> 
                    <h5 style="margin: 0;">Subject Line: {{ email.subject|default:"(No Subject)" }}</h5>
                </div>
                <div class="card-body-content" style="padding: 0;">
                    <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                        {% if email.body.contentType == 'html' %}
                            {{ email.body.content|safe }}
                        {% else %}
                            <pre style="white-space: pre-wrap;">{{ email.body.content }}</pre>
                        {% endif %}
                    </div>

                    {# --- ATTACHMENT SECTION --- #}
                    {% if attachments %}
                    <div class="attachment-section">
                        <strong style="display:block; margin-bottom:10px; color:#2e7d32; font-size: 14px;">
                            <i class="fas fa-paperclip"></i> Task Attachments:
                        </strong>
                        <div style="display: flex; flex-wrap: wrap;">
                            {% for att in attachments %}
                            <a href="{% url 'download_attachment' message_id=delegation.email_id attachment_id=att.id %}" class="attachment-pill">
                                <i class="fas fa-file-download"></i> 
                                <strong>{{ att.name }}</strong>&nbsp;<small>({{ att.size|filesizeformat }})</small>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if delegation.status != 'DLT' %}
            <div class="custom-card">
                <button class="collapse-toggle" type="button" data-target="#collapseReplyForm">
                    <span><i class="fas fa-reply" style="margin-right: 8px;"></i> Send Reply</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </button>
                <div class="collapse-content" id="collapseReplyForm">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="email_log_type" value="REPLY">
                        <div class="form-group">
                            <label class="form-label">Action Note:</label>
                            <select name="action_notes" class="form-control" required>
                                <option value="Feedback to Member">Feedback to Member</option>
                                <option value="Enquiry to Sanlam">Enquiry to Sanlam</option>
                                <option value="Feedback to Employer">Feedback to Employer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Recipient:</label>
                            <input type="email" class="form-control" name="reply_recipient" value="{{ email.from.emailAddress.address }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject:</label>
                            <input type="text" class="form-control" name="reply_subject" value="RE: {{ email.subject }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Body:</label>
                            <textarea class="form-control" name="reply_body" rows="6"></textarea>
                        </div>
                        <button type="submit" class="custom-btn btn-primary">Send Email</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="right-column">
            <div class="custom-card">
                <!--<div class="card-header-dark">
                    <i class="fas fa-clipboard-list" style="margin-right: 10px;"></i>
                    <h5 style="margin: 0;">History</h5>
                </div>-->
                <div class="card-body-content">
                    <!--<div class="notes-history-container">
                        {% for note in notes %}
                        <div class="note-item">
                            <small><strong>{{ note.user.username }}</strong> - {{ note.created_at|date:"M d, H:i" }}</small>
                            <p>{{ note.content }}</p>
                        </div>
                        {% empty %}
                        <div style="padding:10px; color:#777;">No history available.</div>
                        {% endfor %}
                    </div>-->
                    {% if delegation.status != 'DLT' %}
                    <button class="collapse-toggle" style="border-bottom: 3px solid #28a745;" type="button" data-target="#collapseAddNote">
                        <span><i class="fas fa-plus-circle" style="color: #28a745;"></i> Add Note</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </button>
                    <div class="collapse-content" id="collapseAddNote">
                        <form method="POST" style="margin-top:10px;">
                            {% csrf_token %}
                            <textarea class="form-control" name="note_content" rows="4" required></textarea>
                            <button type="submit" class="custom-btn btn-success">Save Note</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if delegation.status == 'DLT' %}
                <a href="{% url 'outlook_recycle_bin' %}" class="custom-btn btn-back">
                    <i class="fas fa-arrow-left"></i> Back to Recycle Bin
                </a>
            {% else %}
                <a href="{% url 'outlook_delegated_box' %}" class="custom-btn btn-back">
                    <i class="fas fa-arrow-left"></i> Back to My Dashboard
                </a>
            {% endif %}

            {% if delegation.status != 'COM' and delegation.status != 'DLT' %}
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="mark_complete">
                <button type="submit" class="custom-btn btn-success" style="margin-top: 10px;">
                    <i class="fas fa-check-double"></i> MARK AS COMPLETED
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.collapse-toggle').forEach(button => {
            const targetId = button.getAttribute('data-target');
            const targetEl = document.querySelector(targetId);
            if (targetEl) {
                button.addEventListener('click', function() {
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    targetEl.classList.toggle('show');
                    this.setAttribute('aria-expanded', !isExpanded);
                    this.querySelector('.toggle-icon').classList.toggle('fa-chevron-up');
                    this.querySelector('.toggle-icon').classList.toggle('fa-chevron-down');
                });
            }
        });
    });
</script>
{% endblock %}