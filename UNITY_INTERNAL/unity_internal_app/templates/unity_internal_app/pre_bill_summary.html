{% load static %}<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pre-Bill Summary</title>
<style>
body{font-family:sans-serif;background:linear-gradient(to bottom, #d1e2c4, #d1e2c4);margin:20px;color:#333;line-height:1.2;}
h2{color:#1b5e20;margin-bottom:15px;font-size:1.5em;padding-bottom:5px;border-bottom:2px solid #81c784;}
h3{color:#1b5e20;margin-top:20px;margin-bottom:10px;font-size:1.2em;}
.container{max-width:98%;margin:1em auto;padding:1em;}
.return-button{display:inline-block;padding:10px 20px;margin-bottom:20px;background-color:#81c784;border:1px solid #81c784;border-radius:5px;text-decoration:none;color:white;cursor:pointer;transition:background-color 0.3s ease;font-size:1em;}
.return-button:hover{background-color:#66bb6a;}
.metrics-row{display:flex;gap:20px;margin-bottom:20px;justify-content:space-around;}
.metric-card{flex:1;min-width:200px;padding:15px;border-radius:5px;color:white;box-shadow:0 4px 8px rgba(0,0,0,0.1);text-align:center;}
.metric-card.blue{background-color:#2196F3;}
.metric-card.green{background-color:#4CAF50;}
.metric-card.primary{background-color:#3f51b5;}
.metric-card.purple{background-color:#9c27b0;}
.metric-card.orange{background-color:#ff9800;}
.card-title{font-size:0.9em;opacity:0.8;margin-bottom:5px;}
.card-text{font-size:1.5em;font-weight:bold;margin:0;}
.card-body small{display:block;margin-top:5px;font-size:0.8em;opacity:0.9;}
hr{border:0;border-top:1px solid #aed581;margin:20px 0;}
table{width:100%;border-collapse:collapse;box-shadow:0 2px 5px rgba(0, 0, 0, 0.1);border-radius:5px;overflow:hidden;background-color:#f0fff0;border:1px solid #c3e6cb;margin-bottom:20px;font-size:0.9em;}
thead th{background-color:#43a047;color:white;padding:12px;text-align:left;font-weight:bold;border-bottom:2px solid #388e3c;white-space:nowrap;border-right:1px solid #388e3c;}
thead th:last-child{border-right:none;}
tbody td{padding:10px 12px;border-bottom:1px solid #aed581;border-right:1px solid #aed581;}
tbody td:last-child{border-right:none;}
tbody tr:nth-child(even){background-color:#e6ffe6;}
.alert-info, .text-danger, .text-success{padding:10px;border-radius:4px;margin-bottom:15px;font-weight:bold;display:block;}
.alert-info{background-color:#f0f8ff;border:1px solid #bce8f1;color:#31708f;}
.alert-info.text-danger{background-color:#ffcdd2;color:#c62828;}
.alert-info.text-success{background-color:#c8e6c9;color:#388e3c;}
.bill-details{padding:15px 0;margin-bottom:20px;border-radius:5px;font-size:0.9em;}
.bill-blocks{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:15px;justify-content:center;}
.bill-block{flex-grow:1;flex-basis:180px;min-width:150px;padding:12px 15px;background-color:#f9fff9;border:1px solid #b3e0b3;border-radius:8px;text-align:center;box-shadow:0 2px 5px rgba(0, 0, 0, 0.08);transition:all 0.2s ease-in-out;}
.bill-block:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0, 0, 0, 0.12);}
.bill-block .label{display:block;font-weight:bold;color:#2e7d32;margin-bottom:5px;font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;}
.bill-block .value{display:block;font-size:1.2em;font-weight:600;color:#333;}
.disabled-button{background-color:#aeb4b8 !important;cursor:not-allowed;pointer-events:none;}
.credit-note-table thead th{background-color:#3f51b5;border-bottom:2px solid #303f9f;border-right:1px solid #303f9f;}
.credit-note-table thead th:last-child{border-right:none;}
.credit-note-table tbody tr:nth-child(even){background-color:#e8eaf6;}
.action-button{padding:5px 10px;border:none;border-radius:3px;text-decoration:none;color:white;font-size:0.8em;display:inline-block;background-color:#3f51b5;}
.action-button:hover{background-color:#303f9f;}
.allocation-form-group{display:flex;gap:10px;align-items:center;justify-content:flex-end;}
.allocation-form-group input[type="number"]{width:100px;padding:5px;border:1px solid #ccc;border-radius:4px;text-align:right;}
.allocation-form-group button{background-color:#4CAF50;padding:6px 12px;border:none;color:white;cursor:pointer;border-radius:3px;font-size:0.9em;}
.allocation-row-info{font-size:0.8em;color:#666;margin-top:5px;}
</style>
</head>
<body>
<div class="container">
<h2>
{{ bill_record.C_Company_Code|default:"N/A" }}-
{{ bill_record.D_Company_Name|default:"N/A" }}-
üí∞ Pre-Bill Summary: Debt Reconciliation
</h2>
<a href="{% url 'unity_information' company_code=company_code %}" class="return-button">
‚Üê Back to Information
</a>
{% if messages %}{% for message in messages %}
<div class="alert-info text-success" style="background-color: #c8e6c9; color: #388e3c; border-left: 5px solid #4CAF50;">{{ message }}</div>
{% endfor %}{% endif %}
<div class="metrics-row">
<div class="metric-card green">
<div class="card-body">
<h5 class="card-title">Scheduled Bill Amount (Original)</h5>
<p class="card-text">R {{ scheduled_amount|floatformat:2 }}</p>
<small>
Remaining Schedule: R{{ remaining_schedule_amount|floatformat:2 }}
{% if over_scheduled_amount > 0 %}
<br>**R {{ over_scheduled_amount|floatformat:2 }}** recorded as **Unapplied Surplus**.
{% endif %}
</small>
</div>
</div>
<div class="metric-card blue">
<div class="card-body">
<h5 class="card-title">Total Available Balance</h5>
<p class="card-text">R {{ total_debt|floatformat:2 }}</p>
<small>Total assigned cash available to settle bills.</small>
</div>
</div>
<div class="metric-card purple">
<div class="card-body">
<h5 class="card-title">Credit Allocated (Used)</h5>
<p class="card-text">R {{ total_credit_notes_assigned|default:"0.00"|floatformat:2 }}</p>
<small>Sum of Credit Notes applied to this bill.</small>
</div>
</div>

<div class="metric-card primary">
<div class="card-body">
<h5 class="card-title">Outstanding (Debt - Remaining Schedule)</h5>
<p class="card-text" id="dynamic-outstanding">R {{ current_outstanding|floatformat:2 }}</p>
<small id="dynamic-outstanding-small">
{% if current_outstanding > 0 %}
**R {{ current_outstanding|floatformat:2 }}** remains **Unbilled Debt**.
{% elif current_outstanding < 0 %}
**R {{ current_outstanding|floatformat:2|slice:"1:" }}** is **Over-scheduled**.
{% else %}
Debt is perfectly matched to the Remaining Scheduled Amount.
{% endif %}
</small>
</div>
</div>
</div>

{% if not bill_record.is_reconciled %}
<hr>
{% if is_proceed_enabled or total_debt == 0 and remaining_schedule_amount == 0 %}
<div class="alert-info text-success" style="background-color: #c8e6c9; color: #388e3c;">
{% if total_debt == 0 and remaining_schedule_amount == 0 %}
<strong>Ready to Close:</strong> The Bill is fully balanced. Click Proceed to finalize.
{% else %}
{{ action_message }} **Ready to Proceed to Recon?.**
{% endif %}
</div>
<a href="{% url 'finalize_reconciliation' company_code=company_code bill_id=bill_record.id %}"
class="return-button"
style="background-color: #388e3c; margin-bottom: 20px;">
Proceed to Recon (Finalize)
</a>
{% else %}
<div class="alert-info text-danger" style="background-color: #ffcdd2; color: #c62828;">
**Action Required:** {{ action_message }} Settlement is unavailable until more debt is applied or the schedule is manually reduced.
</div>
<button class="return-button disabled-button" style="margin-bottom: 20px;">
Proceed to Recon (Unavailable)
</button>
{% endif %}
<hr>
<h3>Associated Cash Lines Available for Allocation ({{ all_lines|length }} items)</h3>
<p>
Select a line, enter the amount to apply (max is remaining available or remaining bill schedule), 
and optionally check the box to create a new unassigned line from the remainder.
</p>

<table>
<thead>
<tr>
<th>Select</th>
<th>Bank Line ID</th>
<th>Deposit Date</th>
<th>Available Balance</th>
<th>Status</th>
<th>Action / Amount to Apply</th>
</tr>
</thead>
<tbody>
{% for line in all_lines %}
<form method="POST" action="{% url 'process_cash_allocation' company_code=company_code bill_id=bill_record.id %}">
{% csrf_token %}
<input type="hidden" name="company_code" value="{{ company_code }}">
<input type="hidden" name="bill_id" value="{{ bill_record.id }}">
<tr {% if line.is_fully_consumed %}style="background-color: #f0f0f0; color: #888;"{% endif %}>
<td>
{% if not line.is_fully_consumed %}
<input type="radio" name="selected_recon_id" value="{{ line.id }}" class="recon-radio" data-max-amount="{{ line.remaining_debt|floatformat:2 }}" required>
{% else %}
<input type="radio" disabled>
{% endif %}
</td>
<td>{{ line.id }}</td>
<td>{{ line.transaction_date|date:"Y-m-d" }}</td>
<td style="font-weight: bold; color: {% if line.remaining_debt > 0 %}#388e3c{% else %}#888{% endif %};">
R {{ line.remaining_debt|floatformat:2 }}
</td>
<td>
<span style="font-size: 0.85em;">{{ line.recon_status }}</span>
</td>
<td>
{% if not line.is_fully_consumed %}
<div class="allocation-form-group">
<input type="number" name="amount_to_apply" id="amount-{{ line.id }}" class="amount-input" step="0.01" min="0.01" max="{{ line.remaining_debt|floatformat:2 }}" placeholder="0.00">
<label title="If the applied amount is less than the available balance, check this box to create a new unassigned ReconnedBank line for the remainder.">
<input type="hidden" name="split_and_reallocate" value="False">
<input type="checkbox" name="split_and_reallocate" value="True"> Split & Unassign Remainder
</label>
<button type="submit" class="action-button">Apply Cash</button>
</div>
{% else %}
<span style="color: #888;">Fully Consumed</span>
{% endif %}
</td>
</tr>
</form>

<tr class="allocation-row-info">
<td></td>
<td colspan="5">
Original Amount: R {{ line.transaction_amount|floatformat:2 }} | 
Description: {{ line.bank_line.transaction_description|truncatechars:100 }}
</td>
</tr>
{% empty %}
<tr><td colspan="6" style="text-align: center;">No available cash lines to allocate.</td></tr>
{% endfor %}
</tbody>
</table>
<hr>

{% if credit_notes %}
<h3 style="color: #3f51b5;">üí≤ Associated Credit Notes ({{ credit_notes|length }} items)</h3>
<p>These are credit portions that have been approved by the manager and applied to this specific bill.</p>
<table class="credit-note-table" style="background-color: #f0f8ff; border: 1px solid #b3e0ff;">
    <thead>
        <tr>
            <th>ID</th>
            <th>Processed Date</th>
            <th>Original Amount</th>
            <th style="background-color: #283593;">Applied to Bill</th>
            <th>Remaining Balance</th>
            <th>Status</th>
            <th>Imported By</th>
        </tr>
    </thead>
    <tbody>
        {% for note in credit_notes %}
        <tr {% if not note.fiscal_date %}style="background-color: #fff3cd;"{% endif %}>
            <td>{{ note.id }}</td>
            <td>{{ note.processed_date|date:"Y-m-d"|default:"N/A" }}</td>

            <td>R {{ note.schedule_amount|add:note.requested_amount|floatformat:2 }}</td>

            <td style="font-weight: bold; color: white; background-color: #3949ab;">
                R {{ note.requested_amount|default:"0.00"|floatformat:2 }}
            </td>

            <td style="color: #1b5e20; font-weight: bold;">
                R {{ note.schedule_amount|default:"0.00"|floatformat:2 }}
            </td>

            <td>
                {% if note.schedule_amount > 0 %}
                    <span style="color: #f57f17; font-weight: bold;">PARTIAL</span>
                {% else %}
                    <span style="color: #388e3c; font-weight: bold;">FULLY USED</span>
                {% endif %}
            </td>
            <td>{{ note.processed_by }}</td>
        </tr>
        {% endfor %}
        <tr style="background-color: #e8eaf6; font-weight: bold;">
            <td colspan="3" style="text-align: right;">Total Credit Applied:</td>
            <td style="color: #283593; background-color: #c5cae9;">R {{ total_credit_notes_assigned|floatformat:2 }}</td>
            <td colspan="3"></td>
        </tr>
    </tbody>
</table>
<hr>
{% endif %}

{% if available_surpluses and remaining_schedule_amount > 0 %}
<div style="background-color: #e3f2fd; padding: 15px; border: 1px solid #90caf9; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
<h3 style="color: #1565c0; margin-top: 0; border-bottom: 1px solid #bbdefb; padding-bottom: 10px;">
üí∞ Available Surplus Funds (Manual Allocation)
</h3>
<p style="font-size: 0.9em; color: #555;">
The following funds are available from previous bills for <strong>{{ company_code }}</strong>.
Allocating these funds will create a Journal Entry to reduce the remaining schedule.
</p>
<table style="width: 100%; background: white; border-collapse: collapse;">
<thead>
<tr style="background: #bbdefb; color: #0d47a1;">
<th style="padding: 8px;">Source Bill Date</th>
<th style="padding: 8px;">Available Now</th>
<th style="padding: 8px;">Action</th>
</tr>
</thead>
<tbody>
{% for surplus in available_surpluses %}
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px;">{{ surplus.origin_date|date:"Y-m-d" }} (Bill #{{ surplus.unity_bill_source_id }})</td>
<td style="padding: 8px; font-weight: bold; color: green;">R {{ surplus.temp_available|floatformat:2 }}</td>
<td style="padding: 8px;">
<form action="{% url 'allocate_surplus_to_bill' bill_id=bill_record.id %}" method="POST" style="display: flex; gap: 10px; align-items: center;">
{% csrf_token %}
<input type="hidden" name="surplus_id" value="{{ surplus.id }}">
<div style="display: flex; align-items: center;">
<span style="margin-right: 5px; font-weight: bold;">R</span>
<input type="number" name="amount" step="0.01" min="0.01" max="{{ surplus.temp_available|floatformat:2 }}" placeholder="0.00" required style="width: 100px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
</div>
<button type="submit" class="dashboard-button" style="padding: 5px 15px; font-size: 12px; background-color: #1976d2; border: none; color: white; cursor: pointer; border-radius: 3px;">Allocate</button>
</form>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

{% if applied_journals %}
<h3 class="credit-heading" style="color: #4527a0; border-bottom: 2px solid #d1c4e9; margin-top: 30px;">
Journal Entries (Applied Surplus)
</h3>
<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
<thead>
<tr style="background-color: #ede7f6; color: #4527a0;">
<th style="padding: 10px; text-align: left;">Date</th>
<th style="padding: 10px; text-align: left;">Source Reference</th>
<th style="padding: 10px; text-align: left;">Created By</th>
<th style="padding: 10px; text-align: left;">Amount</th>
<th style="padding: 10px; text-align: center;">Action</th>
</tr>
</thead>
<tbody>
{% for journal in applied_journals %}
<tr style="border-bottom: 1px solid #f3e5f5;">
<td style="padding: 10px;">{{ journal.allocation_date|date:"Y-m-d" }}</td>
<td style="padding: 10px;">
Surplus #{{ journal.surplus_source.id }}
<span style="font-size: 0.85em; color: #888;">(from Bill #{{ journal.surplus_source.unity_bill_source_id }})</span>
</td>
<td style="padding: 10px;">{{ journal.created_by }}</td>
<td style="padding: 10px; font-weight: bold;">R {{ journal.amount|floatformat:2 }}</td>
<td style="padding: 10px; text-align: center;">
<form action="{% url 'unallocate_surplus_from_bill' bill_id=bill_record.id %}" method="POST" style="margin: 0; display: inline;">
{% csrf_token %}
<input type="hidden" name="journal_entry_id" value="{{ journal.id }}">
<input type="hidden" name="company_code" value="{{ company_code }}"> 
<button type="submit" class="action-button" style="background-color: #d32f2f; padding: 5px 10px;" 
onclick="return confirm('Are you sure you want to unallocate R{{ journal.amount|floatformat:2 }} from this bill? This will reverse the Journal Entry.');">
Remove
</button>
</form>
</td>
</tr>
{% endfor %}
<tr style="background-color: #f3e5f5; font-weight: bold;">
<td colspan="3" style="padding: 10px; text-align: right;">Total Allocated:</td>
<td style="padding: 10px; color: #4527a0;">R {{ total_journal_assigned|floatformat:2 }}</td>
<td style="padding: 10px;"></td>
</tr>
</tbody>
</table>
{% endif %}
{% else %}
<div class="alert-info" style="border-left: 5px solid #2e7d32;">
<strong>Reconciliation Complete:</strong> The schedule is fully satisfied and this bill is closed.
</div>
{% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.recon-radio');
    const amountInputs = document.querySelectorAll('.amount-input');
    
    const outstandingDisplay = document.getElementById('dynamic-outstanding');
    const outstandingSmall = document.getElementById('dynamic-outstanding-small');
    
    const scheduledAmount = parseFloat("{{ scheduled_amount|default:0 }}");
    const creditAllocated = parseFloat("{{ total_credit_notes_assigned|default:0 }}");
    const journalAllocated = parseFloat("{{ total_journal_assigned|default:0 }}");
    const cashAlreadyInDB = parseFloat("{{ total_cash_applied|default:0 }}");

    function calculateLiveOutstanding() {
        let currentTypedCash = 0;
        
        amountInputs.forEach(input => {
            const val = parseFloat(input.value);
            if (!isNaN(val)) {
                currentTypedCash += val;
            }
        });

        let remaining = scheduledAmount - creditAllocated - journalAllocated - cashAlreadyInDB - currentTypedCash;
        
        if (remaining < 0) remaining = 0;

        const formatted = new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(remaining);
        outstandingDisplay.innerText = formatted;
        
        if (remaining <= 0.01) {
            outstandingDisplay.style.color = "#4CAF50"; 
            outstandingSmall.innerHTML = "Debt is perfectly matched to the Remaining Scheduled Amount.";
        } else {
            outstandingDisplay.style.color = "white";
            outstandingSmall.innerHTML = `**${formatted}** remains **Unbilled Debt**.`;
        }
    }

    checkboxes.forEach(box => {
        box.type = "checkbox";

        box.addEventListener('change', function() {
            const lineId = this.value; 
            const maxOnLine = parseFloat(this.dataset.maxAmount); 
            const targetInput = document.getElementById('amount-' + lineId);

            if (this.checked) {
                if (targetInput.value === "" || targetInput.value === "0") {
                    let otherTyped = 0;
                    amountInputs.forEach(i => { if(i.id !== targetInput.id) otherTyped += parseFloat(i.value || 0); });
                    
                    let stillNeeded = scheduledAmount - (creditAllocated + journalAllocated + cashAlreadyInDB + otherTyped);
                    let fillVal = Math.min(maxOnLine, Math.max(0, stillNeeded));
                    targetInput.value = fillVal.toFixed(2);
                }
            } else {
                targetInput.value = '';
            }
            calculateLiveOutstanding();
        });
    });

    amountInputs.forEach(input => {
        input.addEventListener('input', function() {
            const row = this.closest('tr');
            const box = row.querySelector('.recon-radio');
            
            if (parseFloat(this.value) > 0) {
                box.checked = true;
            } else if (this.value === "") {
                box.checked = false;
            }
            calculateLiveOutstanding();
        });
    });

    calculateLiveOutstanding();
});
</script>
</body>
</html>