{% load static %}
{% load math_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_fallback %}{{ unity_record.B_Company_Name }}{% else %}{{ unity_record.b_company_name }}{% endif %} Information</title>
    <style>
        /* -------------------------------------- */
        /* BASE STYLES */
        /* -------------------------------------- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: sans-serif;
            font-size: 14px;
            background: linear-gradient(to bottom, #d1e2c4, rgb(143, 207, 127));
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 95%;
            max-width: 98%;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background-color: #f0fff0;
            padding: 1.5em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, .1);
        }

        h1 {
            color: #1b5e20;
            text-align: center;
            flex-grow: 1;
            font-size: 22px;
        }

        /* -------------------------------------- */
        /* DASHBOARD HEADER & BUTTONS */
        /* -------------------------------------- */
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .dashboard-button {
            padding: 8px 16px;
            background-color: #81c784;
            border: 1px solid #81c784;
            border-radius: 5px;
            text-decoration: none;
            color: white;
            font-weight: 700;
            transition: background-color .3s ease;
            font-size: 13px;
        }

        .dashboard-button:hover {
            background-color: #66bb6a;
        }

        .create-bill-button {
            background-color: #3f51b5;
            margin-right: 15px;
        }

        .create-bill-button:hover {
            background-color: #303f9f;
        }

        .billing-buttons-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .return-button-task {
            background-color: #f7931e;
            border-color: #f7931e;
            padding: 8px 16px;
            font-size: 13px;
            margin-right: 15px;
        }

        .return-button-task:hover {
            background-color: #ef6c00;
        }

        /* -------------------------------------- */
        /* LAYOUT AND TABS */
        /* -------------------------------------- */
        .profile-layout {
            display: flex;
            gap: 15px;
            flex: 1;
            min-height: 0;
        }

        .tab-nav {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            width: 180px;
            border-right: 2px solid #aed581;
            overflow-y: auto;
        }

        .tab-nav li {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #81c784;
            border: 1px solid #81c784;
            border-right: none;
            color: white;
            margin-bottom: 4px;
            border-radius: 5px 0 0 5px;
            white-space: nowrap;
            text-align: right;
            transition: all .2s ease;
            font-size: 13px;
        }

        .tab-nav li.active {
            background-color: #f0fff0;
            color: #1b5e20;
            border-top: 2px solid #43a047;
            border-bottom: 2px solid #43a047;
            border-left: 2px solid #43a047;
            font-weight: 700;
            transform: translateX(2px);
            z-index: 1;
        }

        .tab-nav li:hover {
            background-color: #66bb6a;
        }

        .tab-content {
            flex: 1;
            background-color: #f0fff0;
            padding: 15px;
            border: 1px solid #aed581;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* -------------------------------------- */
        /* TABLE STYLES */
        /* -------------------------------------- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #aed581;
            font-size: 13px;
        }

        th {
            background-color: #e6ffe6;
            color: #1b5e20;
            font-weight: 700;
            width: auto;
            white-space: nowrap;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .empty-message {
            text-align: center;
            padding: 15px;
            color: #777;
            font-style: italic;
            font-size: 13px;
        }

        /* Sorting Styles */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .sortable-header:hover {
            background-color: #dcedc8;
        }

        .sortable-header::after {
            content: ' ‚áÖ';
            font-size: .8em;
            color: #888;
            margin-left: 5px;
        }

        .sortable-header.asc::after {
            content: ' ‚ñ≤';
            color: #1b5e20;
        }

        .sortable-header.desc::after {
            content: ' ‚ñº';
            color: #1b5e20;
        }

        /* Specific Column Widths */
        #general-info table th, #edit-mode-container table th {
            width: 30%;
            white-space: normal;
        }

        #bank-lines td, #recon td, #billing td, #company-claims td {
            white-space: nowrap;
            vertical-align: middle;
        }

        #bank-lines th:nth-child(4), #bank-lines th:nth-child(5), #bank-lines th:nth-child(6) {
            width: 10%;
        }
        
        #bank-lines td:nth-child(7) {
            white-space: normal;
            min-width: 150px;
        }

        /* -------------------------------------- */
        /* STATUS TAGS */
        /* -------------------------------------- */
        .status-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: .8em;
        }

        .status-reconcomplete { background-color: #d1c4e9; color: #512da8; }
        .status-open { background-color: #fffde7; color: #fbc02d; }
        .status-pre-bill { background-color: #ffecb3; color: #ff6f00; }
        .status-scheduled { background-color: #c8e6c9; color: #388e3c; }
        .status-awaitinginput { background-color: #e0e0e0; color: #616161; }
        .status-fullyconsumed { background-color: #81c784; color: #1b5e20; }
        .status-partiallyreconciled { background-color: #ff9800; color: white; }
        .status-unreconciled { background-color: #f44336; color: white; }
        .status-assigned { background-color: #3f51b5; color: white; }

        /* -------------------------------------- */
        /* MISC COMPONENTS */
        /* -------------------------------------- */
        .credit-heading {
            color: #3f51b5;
            margin-top: 20px;
            border-bottom: 2px solid #aed581;
            padding-bottom: 5px;
        }
        
        .credit-table th {
            background-color: #e8eaf6;
            color: #3f51b5;
        }
        
        .form-input, .form-select {
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 100%; 
            box-sizing: border-box;
        }
        
        .save-info-btn {
            background-color: #2e7d32; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        }
        
        .cancel-btn {
            background-color: #ef5350; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-right: 10px;
        }

        /* Email Modal & Logs */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
        }
        /* -------------------------------------- */
    /* NEW EMAIL TABLE STYLES */
    /* -------------------------------------- */
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        font-family: sans-serif;
        font-size: 13px;
        margin-top: 15px;
        background-color: #fff;
        border-radius: 6px 6px 0 0;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .styled-table thead tr {
        background-color: #e8f5e9; /* Light Green Background */
        color: #2e7d32; /* Dark Green Text */
        text-align: left;
    }

    .styled-table th, .styled-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }

    .styled-table th {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
    }

    .styled-table tbody tr:hover {
        background-color: #f1f8e9;
    }

    /* Column Specifics */
    .type-cell {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #555;
    }

    .subject-cell {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #333;
        font-weight: 500;
    }

    /* Thread Button */
    .btn-thread {
        background-color: #81c784;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 20px; /* Pill shape */
        font-size: 11px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
        text-transform: uppercase;
    }

    .btn-thread:hover {
        background-color: #4caf50;
    }
    </style>
</head>
<body>

<div class="container">
    
    <div class="dashboard-header">
        <a href="{% url 'unity_list' %}" class="dashboard-button">Back to List</a>

        <div style="display: flex; align-items: center; gap: 10px;">
            {% if return_to_task and return_url %}
            <a href="{{ return_url }}" class="dashboard-button return-button-task">
                ‚Ü©Ô∏è Return to Delegated Task
            </a>
            {% endif %}
        </div>

        <h1>Unity Management Details for {% if is_fallback %}{{ unity_record.B_Company_Name }} (Limited Data){% else %}{{ unity_record.b_company_name }}{% endif %}</h1>
        <div></div>
    </div>

    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="fallback-warning">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="profile-layout">
        
        <ul class="tab-nav">
            <li class="active" data-tab-target="#general-info">General Info</li>
            <li data-tab-target="#bank-lines">Bank Lines & Credit</li>
            <li data-tab-target="#company-claims">Company Claims</li>
            <li data-tab-target="#recon">Open Bills</li>
            <li data-tab-target="#billing">Recon History</li>
            <li data-tab-target="#notes-log">Notes</li>
            <li data-tab-target="#email-log">Emails</li>
        </ul>

        <div class="tab-content">

            <div id="general-info" class="tab-pane active">
                {% if is_fallback %}
                    <div class="fallback-warning">Full details are unavailable. This record exists only in the Internal Funds list.</div>
                    <table><tbody><tr><th>Company Code</th><td>{{ unity_record.A_Company_Code }}</td></tr><tr><th>Company Name</th><td>{{ unity_record.B_Company_Name }}</td></tr><tr><th>Source</th><td>{{ unity_record.Source }}</td></tr></tbody></table>
                {% else %}
                    <div id="view-mode-container">
                        <button type="button" class="edit-btn" onclick="toggleEditMode(true)">‚úèÔ∏è Edit Details</button>
                        <div style="clear: both;"></div>
                        <table>
                            <tbody>
                                <tr><th>Company Code</th><td>{{ unity_record.a_company_code }}</td></tr>
                                <tr><th>Company Name</th><td>{{ unity_record.b_company_name }}</td></tr>
                                <tr><th>Recon Contact 1</th><td>{{ unity_record.recon_contact_1_name|default:"-" }} <br><small style="color:#666">{{ unity_record.recon_contact_1_email|default:"" }}</small></td></tr>
                                <tr><th>Recon Contact 2</th><td>{{ unity_record.recon_contact_2_name|default:"-" }} <br><small style="color:#666">{{ unity_record.recon_contact_2_email|default:"" }}</small></td></tr>
                                <tr><th>Commencement Date</th><td>{{ unity_record.commencement_date|date:"Y-m-d"|default:"-" }}</td></tr>
                                <tr><th>Fund Status</th><td>{{ unity_record.fund_status|default:"-" }}</td></tr>
                                <tr><th>Fund Status Date</th><td>{{ unity_record.fund_status_date|date:"Y-m-d"|default:"-" }}</td></tr>
                                <tr><th>Last Recon Note</th><td>{{ unity_record.i_last_recon }}</td></tr>
                                <tr><th>Agent</th><td>{{ unity_record.c_agent }}</td></tr>
                                <tr><th>Company Status</th><td>{{ unity_record.d_company_status }}</td></tr>
                                <tr><th>Payment Method</th><td>{{ unity_record.e_payment_method }}</td></tr>
                                <tr><th>Billing Method</th><td>{{ unity_record.f_billing_method }}</td></tr>
                                <tr><th>Current Fiscal</th><td>{{ unity_record.g_current_fiscal }}</td></tr>
                                <tr><th>Current Status</th><td>{{ unity_record.h_current_status }}</td></tr>
                                <tr><th>Arrears</th><td>{{ unity_record.j_arrears }}</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="edit-mode-container" style="display: none;">
                        <h2 style="margin-top: 0; color: #f57f17; border-bottom: 2px solid #f9a825; padding-bottom: 10px;">Editing Company Profile</h2>
                        <form method="POST" action="">
                            {% csrf_token %}
                            <input type="hidden" name="update_general_info" value="true">
                            <table>
                                <tbody>
                                    <tr style="background-color: #eee;"><th>Company Code</th><td>{{ unity_record.a_company_code }}</td></tr>
                                    <tr style="background-color: #eee;"><th>Company Name</th><td>{{ unity_record.b_company_name }}</td></tr>
                                    <tr><th>Recon Contact 1 ‚Äì Name & Surname</th><td><input type="text" name="recon_contact_1_name" value="{{ unity_record.recon_contact_1_name|default:'' }}" class="form-input" placeholder="Enter Name"></td></tr>
                                    <tr><th>Recon Contact 1 ‚Äì Email Address</th><td><input type="email" name="recon_contact_1_email" value="{{ unity_record.recon_contact_1_email|default:'' }}" class="form-input" placeholder="Enter Email"></td></tr>
                                    <tr><th>Recon Contact 2 ‚Äì Name & Surname</th><td><input type="text" name="recon_contact_2_name" value="{{ unity_record.recon_contact_2_name|default:'' }}" class="form-input" placeholder="Enter Name"></td></tr>
                                    <tr><th>Recon Contact 2 ‚Äì Email Address</th><td><input type="email" name="recon_contact_2_email" value="{{ unity_record.recon_contact_2_email|default:'' }}" class="form-input" placeholder="Enter Email"></td></tr>
                                    <tr><th>Commencement Date</th><td><input type="date" name="commencement_date" value="{{ unity_record.commencement_date|date:'Y-m-d' }}" class="form-input"></td></tr>
                                    <tr><th>Fund Status Date</th><td><input type="date" name="fund_status_date" value="{{ unity_record.fund_status_date|date:'Y-m-d' }}" class="form-input"></td></tr>
                                    <tr><th>Last Recon Note</th><td><input type="text" name="last_recon_note" value="{{ unity_record.i_last_recon }}" class="form-input" placeholder="Note content..."></td></tr>
                                    <tr><th>Agent</th><td>
                                        <select name="agent" class="form-select">
                                            <option value="" {% if not unity_record.c_agent %}selected{% endif %}>-- Select Agent --</option>
                                            <option value="karen" {% if unity_record.c_agent == 'karen' %}selected{% endif %}>karen</option>
                                            <option value="Mymoena" {% if unity_record.c_agent == 'Mymoena' %}selected{% endif %}>Mymoena</option>
                                            <option value="merril" {% if unity_record.c_agent == 'merril' %}selected{% endif %}>merril</option>
                                            <option value="gail" {% if unity_record.c_agent == 'gail' %}selected{% endif %}>gail</option>
                                            <option value="Gail Le Roux" {% if unity_record.c_agent == 'Gail Le Roux' %}selected{% endif %}>Gail Le Roux</option>
                                        </select>
                                    </td></tr>
                                    </tbody>
                            </table>
                            <div style="text-align: right; padding-top: 10px;">
                                <button type="button" class="cancel-btn" onclick="toggleEditMode(false)">Cancel</button>
                                <button type="submit" class="save-info-btn">Save General Info</button>
                            </div>
                        </form>
                    </div>
                {% endif %}
            </div>

            <div id="bank-lines" class="tab-pane">
                <h2 style="color:#388e3c; border-bottom: 2px solid #aed581; padding-bottom: 5px;">
                    üí∞ Available Surplus: R {{ available_surplus|default:"0.00"|floatformat:2 }}
                </h2>
                <div style="margin-bottom: 20px; font-size: 0.9em; color: #555;">
                    This figure represents the total unallocated surplus funds derived from settled bills.
                </div>
                
                <h2>Associated Bank Lines (Cash Segments)</h2>
                {% if bank_lines %}
                    <table>
                        <thead>
                            <tr>
                                <th>Segment ID</th>
                                <th>Deposit Date</th>
                                <th>Original Deposit</th>
                                <th>Settled/Consumed</th>
                                <th>Remaining Balance</th>
                                <th>Status</th>
                                <th>Review Note</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for line in bank_lines %}
                                {% with remaining_balance=line.transaction_amount|sub:line.amount_settled %}
                                <tr onclick="window.location.href='{% url 'display_bankline_review' line.id %}?source=unity'" 
                                    style="cursor: pointer; {% if remaining_balance <= 0 %}background-color: #f0f0f0; color: #888;{% endif %}">
                                    <td>#{{ line.id }}</td>
                                    <td>{{ line.transaction_date|date:"Y-m-d" }}</td>
                                    <td>R {{ line.transaction_amount|floatformat:2 }}</td>
                                    <td style="color: #ff9800; font-weight: bold;">R {{ line.amount_settled|floatformat:2 }}</td>
                                    <td style="color: {% if remaining_balance > 0 %}#1b5e20{% else %}#888{% endif %}; font-weight: bold;">
                                        R {{ remaining_balance|floatformat:2 }}
                                    </td>
                                    <td><span class="status-tag status-{{ line.recon_status|lower|cut:' '|cut:'-' }}">{{ line.recon_status }}</span></td>
                                    <td>{{ line.review_note|default:"-"|truncatechars:30 }}</td>
                                    <td>
                                        <a href="{% url 'display_bankline_review' line.id %}?source=unity" class="dashboard-button" style="padding: 5px 8px; font-size: 11px; background-color: #3f51b5;" onclick="event.stopPropagation();">Review/Edit</a>
                                    </td>
                                </tr>
                                {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty-message">No reconciled bank lines found for this company code.</p>
                {% endif %}
                
<h2 class="credit-heading">Associated Credit Note Lines</h2>
{% if credit_notes %}
    <table class="credit-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Processed Date</th>
                <th>Original Amount</th>
                <th>Requested/Used</th>
                <th style="color: #3f51b5;">Remaining Balance</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for note in credit_notes %}
            <tr {% if note.credit_link_status != 'Pending' %}onclick="window.location.href='{% url 'assign_fiscal_date' note_id=note.id %}?context=info'"{% endif %} 
                style="cursor: {% if note.credit_link_status == 'Pending' %}not-allowed{% else %}pointer{% endif %}; {% if note.credit_link_status == 'Pending' %}background-color: #fff9c4;{% endif %}">
                
                <td>{{ note.id }}</td>
                <td>{{ note.processed_date|date:"Y-m-d" }}</td>
                
                <td>R {{ note.schedule_amount|add:note.requested_amount|floatformat:2 }}</td>

                <td style="color: #d32f2f; font-weight: bold;">
                    R {{ note.requested_amount|default:"0.00"|floatformat:2 }}
                </td>

                <td style="font-weight: bold; color: #1b5e20;">
                    R {{ note.schedule_amount|default:"0.00"|floatformat:2 }}
                </td>

                <td>
                    {% if note.credit_link_status == 'Pending' %}
                        <span class="status-tag" style="background-color: #f57f17; color: white;">PENDING APPROVAL</span>
                    {% elif note.requested_amount > 0 and note.schedule_amount > 0 %}
                        <span class="status-tag" style="background-color: #81c784; color: white;">PARTIALLY USED</span>
                    {% else %}
                        <span class="status-tag status-open">READY</span>
                    {% endif %}
                </td>

                <td>
                    {% if note.credit_link_status == 'Pending' %}
                        <button class="dashboard-button" style="padding: 5px 8px; font-size: 11px; background-color: #9e9e9e; cursor: not-allowed;" disabled>
                            üîí Locked
                        </button>
                    {% else %}
                        <a href="{% url 'assign_fiscal_date' note_id=note.id %}?context=info" 
                           class="dashboard-button" style="padding: 5px 8px; font-size: 11px; background-color: #3f51b5;">
                           {% if note.schedule_amount > 0 %}Allocate{% else %}View{% endif %}
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}
</div>


<div id="company-claims" class="tab-pane">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2>Company Claims</h2>
        <button type="button" class="dashboard-button" onclick="openClaimModal()">‚ûï New Claim</button>
    </div>

    {% if company_claims %}
        <table id="claimsTable">
            <thead>
                <tr>
                    <th onclick="sortClaimsTable(0)" class="sortable-header">Surname, Initial</th>
                    <th onclick="sortClaimsTable(1)" class="sortable-header">Last Contrib.</th>
                    <th onclick="sortClaimsTable(2)" class="sortable-header">Created</th>
                    <th onclick="sortClaimsTable(3)" class="sortable-header">Type</th>
                    <th onclick="sortClaimsTable(4)" class="sortable-header">Status</th>
                    <th onclick="sortClaimsTable(5)" class="sortable-header">Allocation</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for claim in company_claims %}
                <tr>
                    <td>{{ claim.member_surname }}, {{ claim.member_name|slice:":1" }}</td>
                    <td>{{ claim.last_contribution_date|date:"Y-m-d" }}</td>
                    <td>{{ claim.claim_created_date|date:"Y-m-d" }}</td>
                    <td>
                        {{ claim.claim_type }}
                        {% if claim.linked_email_id %}
                            <span onclick="previewLinkedEmail('{{ claim.id }}')" title="Linked to Email. Click to View Content" style="cursor: pointer; font-size: 1.1em; margin-left: 5px;">üìß</span>
                        {% endif %}
                    </td>
                    <td><span class="status-tag {% if claim.claim_status == 'Paid' %}status-reconcomplete{% else %}status-open{% endif %}">{{ claim.claim_status }}</span></td>
                    <td>{{ claim.claim_allocation }}</td>
                    <td>
                        <button class="dashboard-button"
                            style="padding: 4px 8px; font-size: 11px;"
                            onclick="editClaim(this)"
                            data-id="{{ claim.id }}"
                            data-id_number="{{ claim.id_number }}"
                            data-member_name="{{ claim.member_name }}"
                            data-member_surname="{{ claim.member_surname }}"
                            data-mip_number="{{ claim.mip_number|default:'' }}" 
                            data-claim_type="{{ claim.claim_type }}"
                            data-exit_reason="{{ claim.exit_reason }}"
                            data-claim_allocation="{{ claim.claim_allocation }}"
                            data-claim_status="{{ claim.claim_status }}"
                            data-payment_option="{{ claim.payment_option }}"
                            data-claim_amount="{{ claim.claim_amount|default:'' }}" 
                            data-claim_created_date="{{ claim.claim_created_date|date:'Y-m-d' }}"
                            data-last_contribution_date="{{ claim.last_contribution_date|date:'Y-m-d' }}"
                            data-date_submitted="{{ claim.date_submitted|date:'Y-m-d' }}"
                            data-date_paid="{{ claim.date_paid|date:'Y-m-d' }}"
                            data-linked_email_id="{{ claim.linked_email_id|default:'' }}"
                            data-vested_pot_available="{{ claim.vested_pot_available }}"
                            data-vested_pot_paid_date="{{ claim.vested_pot_paid_date|date:'Y-m-d' }}"
                            data-savings_pot_available="{{ claim.savings_pot_available }}"
                            data-savings_pot_paid_date="{{ claim.savings_pot_paid_date|date:'Y-m-d' }}"
                            data-infund_cert_date="{{ claim.infund_preservation_cert_received_date|date:'Y-m-d' }}"
                            >Edit</button>
                        
                        {% if claim.linked_email_id %}
                        <template id="email-content-{{ claim.id }}">
                            <div class="p-sender">{% firstof claim.email_preview_sender "Unknown" %}</div>
                            <div class="p-subject">{% firstof claim.email_preview_subject "(No Subject)" %}</div>
                            <div class="p-date">{{ claim.email_preview_date|date:"Y-m-d H:i" }}</div>
                            <div class="p-body">{{ claim.email_preview_body|safe }}</div>
                        </template>
                        {% endif %}

                        <template id="notes-data-{{ claim.id }}">
                            {% for note in claim.notes.all %}
                            <tr><td>{{ note.note_description }}</td><td>{{ note.note_selection }}</td><td>{{ note.created_at|date:"Y-m-d H:i" }}</td><td>{{ note.created_by.username }}</td></tr>
                            {% empty %}
                            <tr><td colspan="4" style="text-align:center; color:#777;">No notes found for this claim.</td></tr>
                            {% endfor %}
                        </template>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="empty-message">No claims found for this company.</p>
    {% endif %}

    <div id="emailPreviewModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 2000;">
        <div style="background: white; width: 80%; max-width: 800px; margin: 50px auto; padding: 20px; border-radius: 8px; position: relative;">
            <div style="border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3 style="margin-top:0;">‚úâÔ∏è Linked Email Details</h3>
                <p><strong>From:</strong> <span id="pv_from"></span></p>
                <p><strong>Subject:</strong> <span id="pv_subject"></span></p>
                <p><strong>Date:</strong> <span id="pv_date"></span></p>
            </div>
            <div id="pv_body" style="border: 1px solid #ddd; padding: 15px; max-height: 400px; overflow-y: auto; background: #fafafa;"></div>
            <div style="text-align: right; margin-top: 15px;">
                <button type="button" class="dashboard-button" onclick="document.getElementById('emailPreviewModal').style.display='none'">Close Preview</button>
            </div>
        </div>
    </div>

    <div id="claimModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; width: 90%; max-width: 1000px; margin: 30px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: #1b5e20; border-bottom: 2px solid #aed581; padding-bottom: 10px;">Manage Claim</h2>
            
            <form id="main_claim_form" method="POST" action="{% url 'save_claim' company_code=unity_record.A_Company_Code|default:unity_record.a_company_code %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="claim_id" id="modal_claim_id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div><label style="font-weight:bold;">Company Code</label><input type="text" name="company_code" value="{{ unity_record.A_Company_Code|default:unity_record.a_company_code }}" class="form-input" readonly style="background-color: #eee;"></div>
                    <div><label style="font-weight:bold;">Agent</label><input type="text" name="agent" value="{{ unity_record.c_agent }}" class="form-input" readonly style="background-color: #eee;"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div><label style="font-weight:bold;">ID / Passport *</label><input type="text" name="id_number" class="form-input" required></div>
                    <div id="div_mip_number" style="display:none;"><label style="font-weight:bold; color:#d32f2f;">MIP Number *</label><input type="text" name="mip_number" class="form-input"></div>
                    <div><label style="font-weight:bold;">First Name *</label><input type="text" name="member_name" class="form-input" required></div>
                    <div><label style="font-weight:bold;">Surname *</label><input type="text" name="member_surname" class="form-input" required></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-weight:bold;">Claim Type</label>
                        <select name="claim_type" id="claim_type_select" class="form-select" onchange="toggleTwoPotLogic()">
                            <option value="Withdrawal">Withdrawal</option>
                            <option value="Retirement">Retirement</option>
                            <option value="Death">Death</option>
                            <option value="Disability">Disability</option>
                            <option value="Funeral">Funeral</option>
                            <option value="Surplus">Surplus</option>
                            <option value="Ill-Health">Ill-Health</option>
                            <option value="Two Pot">Two Pot</option> 
                        </select>
                    </div>
                    <div id="div_exit_reason">
                        <label style="font-weight:bold;">Reason For Exit</label>
                        <select name="exit_reason" class="form-select">
                            <option value="">-- Select --</option>
                            <option value="Resignation">Resignation</option>
                            <option value="Dismissal">Dismissal</option>
                            <option value="Retirement">Retirement</option>
                            <option value="Retrenchment">Retrenchment</option>
                            <option value="Death">Death</option>
                            <option value="Disability">Disability</option>
                            <option value="Abscondment">Abscondment</option>
                            <option value="Ill-Health">Ill-Health</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:bold;">Claim Allocation</label>
                        <select name="claim_allocation" class="form-select">
                            <option value="New Claim">New Claim</option>
                            <option value="Dealing With Claim">Dealing With Claim</option>
                            <option value="Claim Query">Claim Query</option>
                            <option value="Claim Paid">Claim Paid</option>
                            <option value="Exit Processed">Exit Processed</option>
                            <option value="Default new claim">Default new claim</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-weight:bold;">Claim Status</label>
                        <select name="claim_status" id="claim_status_select" class="form-select" onchange="toggleWithdrawalSubFields()">
                            <option value="Claim Docs Requested">Claim Docs Requested</option>
                            <option value="Delegated">Delegated</option>
                            <option value="Incomplete">Incomplete</option>
                            <option value="Paid">Paid</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Company in Arrears">Company in Arrears</option>
                            <option value="Payment/Schedule Due">Payment/Schedule Due</option>
                            <option value="Family Member ‚Äì Sent to Sanlam">Family Member ‚Äì Sent to Sanlam</option>
                            <option value="2 pot forms submitted to ER">2 pot forms submitted to ER</option>
                            <option value="Withdraw - Not Allowed">Withdraw - Not Allowed</option>
                            <option value="Withdraw ‚Äì Already Claimed in Current Tax Year">Withdraw ‚Äì Already Claimed in Current Tax Year</option>
                        </select>

                        <div id="div_two_pot_withdrawal_details" style="display:none; margin-top: 10px; padding: 10px; border-left: 3px solid #fbc02d; background: #fffde7; border-radius: 4px;">
                            <label style="font-size: 0.85em; font-weight: bold; color: #bc5100;">Note Helper: Reason</label>
                            <select id="two_pot_withdrawal_status" class="form-select" style="font-size: 0.9em;" onchange="handleWithdrawalStatusChange()">
                                <option value="">-- Select Status --</option>
                                <option value="Withdrawal - Not Allowed">Withdrawal - Not Allowed</option>
                                <option value="Withdrawal - Already claim in current financial year">Withdrawal - Already claim in current financial year</option>
                            </select>

                            <div id="div_prev_claim_date" style="display:none; margin-top: 8px;">
                                <label style="font-size: 0.85em; font-weight: bold; color: #bc5100;">Previous Claim Date</label>
                                <input type="date" id="prev_claim_date_input" class="form-input" style="font-size: 0.9em;" onchange="handleWithdrawalStatusChange()">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="font-weight:bold;">Payment Option</label>
                        <select name="payment_option" id="payment_option_select" class="form-select">
                            <option value="Leave Benefit in Fund">Leave Benefit in Fund</option>
                            <option value="Transfer Full Benefit">Transfer Full Benefit</option>
                            <option value="Portion Cash and Transfer Balance">Portion Cash and Transfer Balance</option>
                            <option value="Pay Full Benefit">Pay Full Benefit</option>
                            <option value="No Payment Instruction">No Payment Instruction</option>
                            <option value="Full Payment">Full Payment</option>
                            <option value="Partially Taken">Partially Taken</option>
                        </select>
                    </div>
                    <div id="div_claim_amount" style="display:none;">
                        <label style="font-weight:bold; color:#d32f2f;">Amount (R) *</label>
                        <input type="number" step="0.01" name="claim_amount" class="form-input" placeholder="0.00">
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 15px; border: 1px solid #1e88e5; border-radius: 8px; background-color: #f1f8ff;">
                    <h4 style="margin-top: 0; color: #1565c0; border-bottom: 1px solid #1e88e5; padding-bottom: 5px;">Pot Availability & Certificates</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #bbdefb;">
                            <label style="font-weight: bold;"><input type="checkbox" name="vested_pot_available" id="id_vested_pot_available" onchange="togglePotVisibility()"> Vested Pot Funds Available</label>
                            <div id="div_vested_paid" style="display: none; margin-top: 5px;">
                                <input type="date" name="vested_pot_paid_date" id="id_vested_pot_paid_date" class="form-input">
                            </div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #bbdefb;">
                            <label style="font-weight: bold;"><input type="checkbox" name="savings_pot_available" id="id_savings_pot_available" onchange="togglePotVisibility()"> Savings Pot Available</label>
                            <div id="div_savings_paid" style="display: none; margin-top: 5px;">
                                <input type="date" name="savings_pot_paid_date" id="id_savings_pot_paid_date" class="form-input">
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="font-weight:bold;">In-Fund Preservation Cert Date:</label>
                        <input type="date" name="infund_cert_date" id="id_infund_cert_date" class="form-input" style="width: 200px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div><label style="font-weight:bold; color: #1b5e20;">Claim Created *</label><input type="date" name="claim_created_date" class="form-input" required value="{% now 'Y-m-d' %}"></div>
                    <div id="div_last_contribution_date"><label style="font-weight:bold;">Last Contribution Date</label><input type="date" name="last_contribution_date" class="form-input"></div>
                    <div><label style="font-weight:bold;">Date Submitted</label><input type="date" name="date_submitted" class="form-input"></div>
                    <div id="div_date_paid"><label style="font-weight:bold;">Date Paid</label><input type="date" name="date_paid" class="form-input"></div>
                </div>

                <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <label style="font-weight: bold; color: #1e88e5;">üîó Linked Email (Optional)</label>
                        <button type="button" onclick="toggleEmailForm()" style="background-color: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úâÔ∏è Compose Email</button>
                    </div>
                    <select id="linked_email_id" name="linked_email_id" class="form-select" style="border: 1px solid #1e88e5; width: 100%;">
                        <option value="">-- Select an email to link --</option>
                        {% for email in my_delegated_emails %}
                            <option value="{{ email.email_id }}">üìÖ {{ email.received_at|date:"Y-m-d" }} | ‚úâÔ∏è {% firstof email.subject email.email_subject "(No Subject)" as subject_text %}{{ subject_text|slice:":40" }}... (From: {% firstof email.sender email.sender_email "Unknown" %})</option>
                        {% empty %}
                            <option value="" disabled>No delegated emails found for you.</option>
                        {% endfor %}
                    </select>

                    <div id="email-composition-container" style="display: none; margin-top: 10px; background: #fffaf5; border: 1px dashed #ff9800; padding: 15px; border-radius: 8px;">
                        <input type="hidden" name="email_body_html_content" id="email_body_html_content">
                        <label>To:</label><input type="text" name="member_recipient_email" class="form-input" placeholder="Email address...">
                        <label>Subject:</label><input type="text" name="member_email_subject_reply" class="form-input">
                        <label>Body:</label>
                        <textarea id="member_email_body_editor" class="form-input" rows="5">Dear Sir/Madam,&#10;&#10;Kind regards,&#10;{{ request.user.username }}</textarea>
                        <button type="submit" name="email_submission_action" value="send_email_and_log" class="dashboard-button" style="margin-top: 10px; background: #f7931e;">Send Email & Save</button>
                    </div>
                </div>

                <hr style="border: 1px solid #aed581; margin: 20px 0;">
                
                <h3 style="color: #38761d;">Add Claim Note</h3>
                <div style="background-color: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #ccc;">
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Note Selection</label>
                        <select name="note_selection" id="note_selection" class="form-select" style="width: 100%;">
                            <option value="">-- Select Note Type (Optional) --</option>
                            <option value="BANK DETAILS FOLLOW UP WITH MEMBER/EMPLOYER">BANK DETAILS FOLLOW UP WITH MEMBER/EMPLOYER</option>
                            <option value="BANK VERIFICATION FAILED ‚Äì SANLAM">BANK VERIFICATION FAILED ‚Äì SANLAM</option>
                            <option value="CLAIM DOCUMENTS REQUESTED">CLAIM DOCUMENTS REQUESTED</option>
                            <option value="SUBMITTED VIA E-MAIL">SUBMITTED VIA E-MAIL</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Note Description</label>
                        <textarea name="note_description" id="note_description" rows="3" class="form-input" style="width: 98%; resize: vertical;" placeholder="Add specific details here..."></textarea>
                    </div>
                    <div style="margin-top: 10px;">
                        <label>Attachment:</label><input type="file" name="claim_attachment" class="form-input">
                    </div>
                </div>

                <h3 style="color: #38761d; margin-top: 20px;">Claim Notes History</h3>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd;">
                    <table style="margin: 0; font-size: 12px; width: 100%;">
                        <thead style="background-color: #eee;"><tr><th>Note Description</th><th>Note Selection</th><th>Created On</th><th>User</th></tr></thead>
                        <tbody id="claim_notes_tbody"><tr><td colspan="4" style="text-align:center; color:#777;">Save claim to add new notes.</td></tr></tbody>
                    </table>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="cancel-btn" onclick="document.getElementById('claimModal').style.display='none'">Cancel</button>
                    <button type="submit" class="save-info-btn">Save Claim Only</button>
                </div>
            </form>
        </div>
    </div>
</div>
            <div id="recon" class="tab-pane">
                <h2 style="color:#388e3c; border-bottom: 2px solid #aed581; padding-bottom: 5px;">
                    üí∞ Available Surplus: R {{ available_surplus|default:"0.00"|floatformat:2 }}
                </h2>
                <h2>Open Bills for Reconciliation</h2>
                <div class="billing-buttons-container">
                    {% with code=unity_record.A_Company_Code|default:unity_record.a_company_code %}
                    <a href="{% url 'create_pre_bill' company_code=code %}" class="dashboard-button create-bill-button" style="padding: 10px 20px; font-size: 14px;">‚ûï Create New Pre-Bill</a>
                    {% endwith %}
                </div>
                
                {% if open_bills %}
                    <div class="billing-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Bill Date (ID)</th>
                                    <th>Schedule Amount</th>
                                    <th style="color: #F44336;">Unsettled Amount</th>
                                    <th>Active Members</th>
                                    <th>Status</th>
                                    <th>Pre-Bill Date</th>       
                                    <th>Schedule Date</th>
                                    <th>Confirm Date</th>       
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in open_bills %}
                                <tr {% if record.display_status == 'AWAITING INPUT' %}style="background-color: #fff8e1;"{% endif %}>
                                    <td>{{ record.A_CCDatesMonth|date:"Y-m-d" }} (#{{ record.id }})</td>
                                    <td>R {{ record.H_Schedule_Amount|default:"0.00"|floatformat:2 }}</td>
                                    <td style="font-weight: bold; color: #F44336;">R {{ record.unsettled_amount|default:"0.00"|floatformat:2 }}</td>
                                    <td>{{ record.E_Active_Members }}</td>
                                    <td><span class="status-tag status-{{ record.display_status|lower|cut:' ' }}">{{ record.display_status }}</span></td>
                                    <td>{{ record.F_Pre_Bill_Date|date:"Y-m-d"|default:"-" }}</td>   
                                    <td>{{ record.G_Schedule_Date|date:"Y-m-d"|default:"-" }}</td>   
                                    <td>{{ record.J_Final_Date|date:"Y-m-d"|default:"-" }}</td>   
                                    <td>
                                        <a href="{% url 'edit_bill' company_code=record.C_Company_Code bill_id=record.id %}" class="dashboard-button" style="padding: 5px 8px; font-size: 11px; background-color: #3f51b5;">Edit Bill</a>
                                        <a href="{% url 'pre_bill_reconciliation_summary' company_code=record.C_Company_Code bill_id=record.id %}" class="dashboard-button" style="padding: 5px 8px; font-size: 11px; background-color: #3f51b5;">Recon</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="empty-message">No open billing records found.</p>
                {% endif %}
            </div>

            <div id="billing" class="tab-pane">
                <h2>Settled Bill Audit History</h2>
                {% if settled_bills %}
                <div class="billing-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill Date (ID)</th>
                                <th>Active Members</th>
                                <th>Schedule Amount</th>
                                <th style="color: #388e3c; background-color: #c8e6c9;">Bankline Total</th>
                                <th style="color: #8e3873ff; background-color: #c8e6c9;">Credit Allocated</th>
                                <th style="color: #5e7014ff; background-color: #c8e6c9;">Surplus Allocated</th>
                                <th style="color: #512da8; background-color: #c8e6c9;">Surplus Created</th>
                                <th>Status</th>
                                <th>Confirm Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for record in settled_bills %}
                            <tr style="background-color: #e8f5e9;">
                                <td>{{ record.A_CCDatesMonth|date:"Y-m-d" }} (#{{ record.id }})</td>
                                <td>{{ record.E_Active_Members }}</td>
                                <td>R {{ record.H_Schedule_Amount|default:"0.00"|floatformat:2 }}</td>
                                <td style="font-weight: bold; color: #388e3c;">R {{ record.bankline_total|default:"0.00"|floatformat:2 }}</td>
                                <td style="font-weight: bold; color: #8e3873ff;">R {{ record.credit_allocated|default:"0.00"|floatformat:2 }}</td>
                                <td style="font-weight: bold; color: #5e7014ff;">R {{ record.surplus_allocated_from_journals|default:"0.00"|floatformat:2 }}</td>
                                <td style="font-weight: bold; color: #512da8;">R {{ record.surplus_created|default:"0.00"|floatformat:2 }}</td>
                                <td><span class="status-tag status-{{ record.display_status|lower|cut:' ' }}">{{ record.display_status }}</span></td>
                                <td>{{ record.J_Final_Date|date:"Y-m-d"|default:"-" }}</td>
                                <td><a href="{% url 'settle_bill_report' company_code=record.C_Company_Code bill_id=record.id %}" class="dashboard-button" style="padding: 5px 8px; font-size: 11px; background-color: #512da8;">View Audit Report</a></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="empty-message">No settled billing records found.</p>
                {% endif %}
            </div>

            <div id="notes-log" class="tab-pane">
                <div class="row" style="display: flex; gap: 20px; min-height: 80vh;">
                    <div class="col-left" style="flex: 2; min-width: 450px;">
                        <form method="post" action="{% url 'unity_information' company_code=unity_record.A_Company_Code|default:unity_record.a_company_code %}" id="notes_master_form" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="communication_type" id="hidden_comm_type" value="Notes Log">
                            <h2 style="margin-top: 0; font-size: 1.8em; color: #1e88e5;">New Action / Note</h2>
                            
                            <div class="row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                                <div class="col-md-12" style="flex: 1;">
                                    <div class="card card-notes-select" style="background-color: #e3f2fd; padding: 15px; border-radius: 8px;">
                                        <label for="id_action_notes" style="font-weight: bold; display: block; margin-bottom: 5px; color: #1565c0;">Note Selector / Action:</label>
                                        <select id="id_action_notes" name="action_notes" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                                            <option value="" disabled selected>Select Action Note</option>
                                            <option value="0101 BALANCE CONFIRMATION FROM SANLAM">0101 BALANCE CONFIRMATION FROM SANLAM</option>
                                            <option value="AD HOC NOTE">AD HOC NOTE</option>
                                            <option value="FEEDBACK TO CRM">FEEDBACK TO CRM</option>
                                            <option value="FEEDBACK TO EMPLOYER">FEEDBACK TO EMPLOYER</option>
                                            <option value="FEEDBACK TO SANLAM">FEEDBACK TO SANLAM</option>
                                            <option value="INBOUND CALL">INBOUND CALL</option>
                                            <option value="NOT FOR RECON - FW TO CORRECT DEPARTMENT">NOT FOR RECON - FW TO CORRECT DEPARTMENT</option>
                                            <option value="OUTBOUND CALL">OUTBOUND CALL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="add-note-form-section" id="regular-note-area" style="display: none; background-color: #f0fff0; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                                <h3 style="margin-top: 0; font-size: 1.3em; color: #38761d;">Note Content</h3>
                                <div style="display: flex; gap: 5px; align-items: stretch;">
                                    <textarea name="note_content" id="regular_note_content" placeholder="Type your detailed note or log of the incoming interaction here..." style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; min-height: 80px;"></textarea>
                                    <button type="submit" name="note_submission_action" value="regular_note" id="regular_note_submit" class="add-note-button" style="padding: 8px 12px; white-space: nowrap; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; height: 100%;">Save Log</button>
                                </div>
                            </div>

                            <div class="dialer-area" id="dialer-area" style="display: none; margin-top: 15px; padding: 15px; border: 2px dashed #38761d; border-radius: 8px; background-color: #f0fff0;">
                                <h3 style="color: #38761d; margin-top: 0; font-size: 1.3em;">‚òéÔ∏è Outgoing Call Details</h3>
                                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group" style="flex: 1;"><label for="dialer_number" style="font-weight: bold;">Number to Dial:</label><input type="text" id="dialer_number" name="dialer_number" placeholder="Mobile or Work Number" style="width: 100%; padding: 10px; border: 1px solid #ccc;"></div>
                                    <div class="form-group" style="flex: 1;"><label for="call_status" style="font-weight: bold;">Call Status:</label><select id="call_status" name="call_status" style="width: 100%; padding: 8px; border: 1px solid #ccc;"><option value="">Select Outcome</option><option value="Completed - Success">Completed - Success</option><option value="Completed - Follow Up">Completed - Follow Up</option><option value="Completed - No Answer">Completed - No Answer</option></select></div>
                                </div>
                                <div style="text-align: center;">
                                    <button type="button" id="trigger_call_dialer" style="padding: 10px; background-color: #4CAF50; color: white; border: none;">üìû Dial Number</button>
                                    <input type="hidden" name="call_duration_seconds" id="call_duration_seconds" value="0">
                                    <button type="submit" name="call_submission_action" value="log_call_note" id="call_note_submit" style="background-color: #3f51b5; color: white; border: none; padding: 10px; margin-left: 10px;">Log Outgoing Call Note</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="col-right" style="flex: 1; min-width: 350px; padding: 15px; background-color: #e3f2fd; border-radius: 8px; overflow-y: auto;">
                        <h2 style="margin-top: 0; font-size: 1.5em; color: #1565c0;">Notes Log</h2>
                        <p style="font-size: 0.9em; color: #555;">Showing Calls, Meetings, and System Notes.</p>
                        
                        {% if communication_logs %}
                            {% for log in communication_logs %}
                            <div class="note-item" style="border-left: 4px solid {% if log.communication_type == 'Incoming Call' %}#4CAF50{% elif log.communication_type == 'Outgoing Call' %}#2196F3{% else %}#795548{% endif %}; padding: 10px; margin-bottom: 10px; background-color: #fff; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                <div style="font-size: 0.85em; display: flex; justify-content: space-between; color: #555;"><span style="font-weight: bold; color: #333;">{{ log.user }}</span><span>{{ log.date|date:"Y-m-d H:i" }}</span></div>
                                <div style="font-size: 0.85em; color: #1565c0; font-weight: bold;">{{ log.communication_type }} {% if log.action_notes %} | <span style="color: #e65100;">{{ log.action_notes }}</span>{% endif %}</div>
                                <p style="margin: 0; font-size: 0.95em; line-height: 1.4; color: #333;">{{ log.notes|linebreaksbr }}</p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-message">No notes found.</p>
                        {% endif %}
                        
                        {% if notes %}
                        <h3 style="margin-top: 20px; font-size: 1.1em; color: #888; border-top: 1px dashed #ccc; padding-top: 10px;">Legacy Notes</h3>
                        {% for note in notes %}
                        <div class="note-item" style="background-color: #f9f9f9; padding: 8px; margin-bottom: 5px; border-left: 3px solid #ccc;"><small style="color: #777;">{{ note.user }} - {{ note.date|date:"Y-m-d" }}</small><p style="margin: 2px 0 0 0; font-size: 0.9em;">{{ note.notes }}</p></div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

<div id="email-log" class="tab-pane">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #aed581; padding-bottom: 10px;">
        <div>
            <h2 style="margin: 0; font-size: 1.5em; color: #1565c0;">Delegated & Sent Emails</h2>
            <p style="font-size: 0.9em; color: #555; margin: 5px 0 0 0;">Tracking delegated emails, replies, and direct outgoing mail.</p>
        </div>
        <button type="button" class="dashboard-button" style="background-color: #ff9800; border-color: #f57c00;" onclick="toggleStandaloneEmailForm()">üìß Compose New Email</button>
    </div>

    <div id="standalone-email-container" style="display: none; margin-bottom: 20px;">
        <form method="post" action="{% url 'unity_information' company_code=unity_record.A_Company_Code|default:unity_record.a_company_code %}" id="standalone_email_master_form" enctype="multipart/form-data" style="background-color: #fffaf5; border: 2px dashed #ff9800; border-radius: 8px; padding: 20px;">
            {% csrf_token %}
            <h3 style="color: #ff9800; margin-top: 0;">Compose Outgoing Email</h3>
            <input type="hidden" name="action" value="send_outgoing_member_note">
            <input type="hidden" name="communication_type" value="Sent Email">
            <input type="hidden" name="action_notes" value="Email Composed"> 
            <input type="hidden" name="note_content" id="standalone_hidden_note_content"> 
            <input type="hidden" name="email_body_html_content" id="standalone_email_html_content">

            <div class="form-group" style="margin-bottom: 10px;">
                <label for="standalone_recipient" style="font-weight: bold; display: block; margin-bottom: 5px;">To (Recipient's Email):</label>
                {% with e1=unity_record.recon_contact_1_email|default:"" e2=unity_record.recon_contact_2_email|default:"" %}
                    <input type="text" id="standalone_recipient" name="member_recipient_email" value="{% if e1 and e2 %}{{ e1 }},{{ e2 }}{% else %}{{ e1 }}{{ e2 }}{% endif %}" placeholder="Enter email addresses..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                {% endwith %}
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Subject:</label>
                <input type="text" name="member_email_subject_reply" value="[MIP: {{ unity_record.A_Company_Code|default:unity_record.a_company_code }}] New Communication" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Email Body:</label>
                <div id="standalone_email_body_editor" class="rich-text-editor" contenteditable="true" style="min-height: 200px; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background-color: white;">
                    <p>Dear Sir/Madam,</p><p>Regarding Member Group Code {{ unity_record.A_Company_Code|default:unity_record.a_company_code }},</p><p><br></p><p>Kind regards,</p><p>{{ request.user.username }}</p>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Attach Documents:</label>
                <input type="file" name="attachments" multiple style="padding: 10px; background: #fff; border: 1px solid #ccc; width: 100%;">
            </div>
            <div style="text-align: right;">
                <button type="button" class="cancel-btn" style="margin-right: 10px;" onclick="toggleStandaloneEmailForm()">Cancel</button>
                <button type="submit" name="email_submission_action" value="send_email_and_log" style="padding: 10px 20px; background-color: #f7931e; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Send Email & Log</button>
            </div>
        </form>
    </div>

    {% if combined_email_log %}
        <div class="table-responsive">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th style="width: 160px;">Email Type</th>
                        <th>Subject</th>
                        <th>Received Date</th>
                        <th>Delegated Date</th>
                        <th>Assigned To / Recipient</th>
                        <th style="width: 120px;">Action / Status</th>
                        <th>Actioned Date</th>
                        <th style="text-align: center;">Thread</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in combined_email_log %}
                    <tr>
                        <td>
                            <div class="type-cell">
                                <span style="font-size: 1.2em;">{{ log.icon }}</span>
                                <span style="font-weight:bold; color: {{ log.badge_color }};">
                                    {% if log.type == 'DIRECT' %}
                                        DIRECT
                                    {% else %}
                                        ORIGINAL
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        <td class="subject-cell" title="{{ log.subject }}">
                            {{ log.subject|default:"(No Subject)" }}
                        </td>
                        <td>{{ log.received_at|date:"Y-m-d H:i"|default:"-" }}</td>
                        <td>{{ log.delegated_at|date:"Y-m-d H:i"|default:"-" }}</td>
                        <td><strong>{{ log.assigned_to|default:"-" }}</strong></td>
                        <td>
                            <span class="status-tag" style="background-color: {{ log.badge_color }}; color: white; font-size: 11px; padding: 4px 8px; border-radius: 4px; display: inline-block; min-width: 80px; text-align: center;">
                                {{ log.display_type|upper }}
                            </span>
                        </td>
                        <td>{{ log.actioned_at|date:"Y-m-d H:i"|default:"-" }}</td>
                        <td style="text-align: center;">
                            {% if log.email_id %}
                                <a href="{% url 'view_email_thread' email_id=log.email_id %}" 
                                   class="btn-thread" style="text-decoration: none; display: inline-block;">
                                    View Thread
                                </a>
                            {% else %}
                                <span style="color: #ccc; font-size: 11px;">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty-message" style="background: white; border-radius: 8px; margin-top: 15px; padding: 20px; text-align: center;">No email history found for this record.</p>
    {% endif %}
</div>

        </div> </div> </div> <script>
    // ==========================================
    // --- 1. CONFIGURATION & GLOBALS ---
    // ==========================================
    const twoPotStatuses = [
        '2 pot forms submitted to ER',
        'Incomplete',
        'Submitted',
        'Withdraw - Not Allowed'
    ];
    
    const twoPotPayments = [
        'Full Payment', 
        'Partially Taken'
    ];

    let originalClaimStatuses = [];
    let originalPaymentOptions = [];

    // ==========================================
    // --- 2. UI HELPERS (Toggles & Sort) ---
    // ==========================================

    function togglePotVisibility() {
        const vested = document.getElementById('id_vested_pot_available').checked;
        const savings = document.getElementById('id_savings_pot_available').checked;
        document.getElementById('div_vested_paid').style.display = vested ? 'block' : 'none';
        document.getElementById('div_savings_paid').style.display = savings ? 'block' : 'none';
        
        if (!vested) document.getElementById('id_vested_pot_paid_date').value = "";
        if (!savings) document.getElementById('id_savings_pot_paid_date').value = "";
    }

    function toggleEditMode(enableEdit) {
        const viewMode = document.getElementById('view-mode-container');
        const editMode = document.getElementById('edit-mode-container');
        if (enableEdit) {
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
        } else {
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
        }
    }

    // Toggles the email form inside the CLAIMS modal
    function toggleEmailForm() {
        const formContainer = document.getElementById('email-composition-container');
        if (formContainer) {
            formContainer.style.display = (formContainer.style.display === 'none') ? 'block' : 'none';
        }
    }

    // FIXED: Toggles the email form inside the standalone EMAILS tab
    function toggleStandaloneEmailForm() {
        const formContainer = document.getElementById('standalone-email-container');
        if (formContainer) {
            formContainer.style.display = (formContainer.style.display === 'none') ? 'block' : 'none';
        }
    }

    function viewEmail(button) {
        const modal = document.getElementById('emailViewModal');
        document.getElementById('modal_email_subject').textContent = button.getAttribute('data-subject');
        document.getElementById('modal_email_sender').textContent = button.getAttribute('data-sender');
        document.getElementById('modal_email_receiver').textContent = button.getAttribute('data-recipient');
        document.getElementById('modal_email_date').textContent = button.getAttribute('data-date');
        
        const hiddenId = button.getAttribute('data-hidden-id');
        const hiddenContainer = document.getElementById(hiddenId);
        
        if (hiddenContainer) {
            const bodyContent = hiddenContainer.querySelector('.email-body-html').innerHTML;
            const attachContent = hiddenContainer.querySelector('.email-attachments-list').innerHTML;
            document.getElementById('modal_email_body').innerHTML = bodyContent;
            document.getElementById('modal_email_attachments').innerHTML = attachContent;
        }
        modal.style.display = 'block';
    }

    function previewLinkedEmail(claimId) {
        const template = document.getElementById('email-content-' + claimId);
        if (!template) {
            alert("Email content not available for this claim snapshot.");
            return;
        }
        
        document.getElementById('pv_from').innerText = template.content.querySelector('.p-sender').innerText;
        document.getElementById('pv_subject').innerText = template.content.querySelector('.p-subject').innerText;
        document.getElementById('pv_date').innerText = template.content.querySelector('.p-date').innerText;
        document.getElementById('pv_body').innerHTML = template.content.querySelector('.p-body').innerHTML;
        
        document.getElementById('emailPreviewModal').style.display = 'block';
    }

    function closeEmailModal() {
        document.getElementById('emailViewModal').style.display = 'none';
    }

    function sortClaimsTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("claimsTable");
        switching = true;
        dir = "asc";
        var headers = table.getElementsByTagName("TH");
        for (var j = 0; j < headers.length; j++) { headers[j].classList.remove("asc", "desc"); }
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                var xContent = x.innerText.toLowerCase();
                var yContent = y.innerText.toLowerCase();
                if (dir == "asc") {
                    if (xContent > yContent) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (xContent < yContent) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; }
            }
        }
        headers[n].classList.add(dir);
    }

    // ==========================================
    // --- 3. DOM LOAD (Tabs, Dialer, Email Editor) ---
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        const statusSel = document.getElementById('claim_status_select');
        if(statusSel) originalClaimStatuses = Array.from(statusSel.options).map(opt => opt.cloneNode(true));

        const paymentSel = document.getElementById('payment_option_select');
        if(paymentSel) originalPaymentOptions = Array.from(paymentSel.options).map(opt => opt.cloneNode(true));

        // Submit listener for CLAIMS Modal form
        const mainClaimForm = document.getElementById('main_claim_form');
        if (mainClaimForm) {
            mainClaimForm.addEventListener('submit', function() {
                const editor = document.getElementById('member_email_body_editor');
                const htmlInput = document.getElementById('email_body_html_content');
                if (editor && htmlInput) {
                    htmlInput.value = editor.value || editor.innerHTML; 
                }
            });
        }

        // FIXED: Submit listener for EMAILS Tab form (standalone)
        const standaloneEmailForm = document.getElementById('standalone_email_master_form');
        if (standaloneEmailForm) {
            standaloneEmailForm.addEventListener('submit', function() {
                const editor = document.getElementById('standalone_email_body_editor');
                const htmlInput = document.getElementById('standalone_email_html_content');
                const textInput = document.getElementById('standalone_hidden_note_content');
                if (editor && htmlInput) {
                    htmlInput.value = editor.innerHTML; 
                    if (textInput) textInput.value = editor.innerText;
                }
            });
        }

        const tabs = document.querySelectorAll('.tab-nav li');
        const panes = document.querySelectorAll('.tab-pane');
        const urlHash = window.location.hash;
        let initialTab = '#general-info';

        if (urlHash && document.querySelector(`.tab-nav li[data-tab-target="${urlHash}"]`)) {
            initialTab = urlHash;
        }

        function switchTab(targetId) {
            tabs.forEach(t => t.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active'));
            const activeTab = document.querySelector(`[data-tab-target="${targetId}"]`);
            const activePane = document.querySelector(targetId);
            if (activeTab && activePane) {
                activeTab.classList.add('active');
                activePane.classList.add('active');
                history.replaceState(null, null, targetId);
            }
        }
        tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tabTarget)));
        switchTab(initialTab);

        const notesMasterForm = document.getElementById('notes_master_form');
        if (notesMasterForm) {
            const actionSelect = document.getElementById('id_action_notes');
            const hiddenCommType = document.getElementById('hidden_comm_type');
            const regularNoteArea = document.getElementById('regular-note-area');
            const dialerArea = document.getElementById('dialer-area');
            const dialButton = document.getElementById('trigger_call_dialer');
            const dialerNumber = document.getElementById('dialer_number');
            const regularNoteContent = document.getElementById('regular_note_content');
            const regularNoteSubmit = document.getElementById('regular_note_submit');

            function toggleCommunicationForms() {
                const selectedValue = actionSelect.value;
                regularNoteArea.style.display = 'none';
                dialerArea.style.display = 'none';
                regularNoteContent.removeAttribute('required');
                dialerNumber.removeAttribute('required');

                if (selectedValue === 'OUTBOUND CALL') {
                    dialerArea.style.display = 'block';
                    regularNoteArea.style.display = 'block';
                    dialerNumber.setAttribute('required', 'required');
                    regularNoteSubmit.style.display = 'none'; 
                    hiddenCommType.value = 'Outgoing Call';
                } else if (selectedValue === 'INBOUND CALL') {
                    regularNoteArea.style.display = 'block';
                    regularNoteSubmit.style.display = 'inline-block';
                    regularNoteContent.setAttribute('required', 'required');
                    hiddenCommType.value = 'Incoming Call';
                } else {
                    regularNoteArea.style.display = 'block';
                    regularNoteSubmit.style.display = 'inline-block';
                    hiddenCommType.value = 'Notes Log';
                }
            }
            actionSelect.addEventListener('change', toggleCommunicationForms);
            if (dialButton) {
                dialButton.addEventListener('click', function() {
                    const phoneNumber = dialerNumber.value.trim();
                    if (phoneNumber === '') { alert('Please enter a number to Dial.'); return; }
                    window.location.href = 'tel:' + phoneNumber.replace(/[^0-9+]/g, '');
                });
            }
            toggleCommunicationForms();
        }
    });

    // ==========================================
    // --- 4. CONDITIONAL WITHDRAWAL LOGIC ---
    // ==========================================

    function toggleWithdrawalSubFields() {
        const status = document.getElementById('claim_status_select').value;
        const helperDiv = document.getElementById('div_two_pot_withdrawal_details');
        const withdrawalDropdown = document.getElementById('two_pot_withdrawal_status');

        if (status === "Withdraw - Not Allowed") {
            helperDiv.style.display = 'block';
            withdrawalDropdown.value = "Withdrawal - Not Allowed";
            handleWithdrawalStatusChange(); 
        } 
        else {
            helperDiv.style.display = 'none';
            withdrawalDropdown.value = '';
            const dateDiv = document.getElementById('div_prev_claim_date');
            if(dateDiv) dateDiv.style.display = 'none';
        }
    }

    function handleWithdrawalStatusChange() {
        const reason = document.getElementById('two_pot_withdrawal_status').value;
        const dateDiv = document.getElementById('div_prev_claim_date');
        const dateInput = document.getElementById('prev_claim_date_input');
        const noteTextarea = document.getElementById('note_description');

        if (reason === 'Withdrawal - Not Allowed') {
            if(dateDiv) dateDiv.style.display = 'none';
            noteTextarea.value = "Withdrawal\n- Not Allowed - Not enough funds available";
        } 
        else if (reason === 'Withdrawal - Already claim in current financial year') {
            if(dateDiv) dateDiv.style.display = 'block';
            const selectedDate = dateInput.value;
            if (selectedDate) {
                const formattedDate = selectedDate.replace(/-/g, '/');
                noteTextarea.value = `Withdrawal\n- Already claim in current financial year - Member claim date = ${formattedDate} - Next Financial Year starting (01 March - End of Feb)`;
            } else {
                noteTextarea.value = `Withdrawal\n- Already claim in current financial year - Member claim date = (Please select date) - Next Financial Year starting (01 March - End of Feb)`;
            }
        }
    }

    // ==========================================
    // --- 5. TWO POT UI LOGIC ---
    // ==========================================
    
    function toggleTwoPotLogic() {
        const typeSelect = document.getElementById('claim_type_select');
        const statusSelect = document.getElementById('claim_status_select');
        const paymentSelect = document.getElementById('payment_option_select');
        const allocationSelect = document.querySelector('select[name="claim_allocation"]');

        const divMip = document.getElementById('div_mip_number');
        const divAmount = document.getElementById('div_claim_amount');
        const divExit = document.getElementById('div_exit_reason');

        if (typeSelect && typeSelect.value === 'Two Pot') {
            if(divMip) divMip.style.display = 'block';
            if(divAmount) divAmount.style.display = 'block';
            if(divExit) divExit.style.display = 'none';

            filterDropdown(statusSelect, twoPotStatuses);
            filterDropdown(paymentSelect, twoPotPayments);
            if(allocationSelect) allocationSelect.value = 'New Claim'; 
        } else {
            if(divMip) divMip.style.display = 'none';
            if(divAmount) divAmount.style.display = 'none';
            if(divExit) divExit.style.display = 'block';

            restoreDropdown(statusSelect, originalClaimStatuses);
            restoreDropdown(paymentSelect, originalPaymentOptions);
        }
        toggleWithdrawalSubFields();
    }

    function filterDropdown(selectElem, allowedValues) {
        if (!selectElem) return;
        const currentVal = selectElem.value;
        selectElem.innerHTML = ''; 
        allowedValues.forEach(val => {
            let opt = document.createElement('option');
            opt.value = opt.text = val;
            selectElem.add(opt);
        });
        if (allowedValues.includes(currentVal)) selectElem.value = currentVal;
    }

    function restoreDropdown(selectElem, originalOptions) {
        if (!selectElem) return;
        const currentVal = selectElem.value;
        selectElem.innerHTML = '';
        originalOptions.forEach(opt => {
            if (opt.value !== "Withdraw ‚Äì Already Claimed in Current Tax Year") {
                selectElem.add(opt.cloneNode(true));
            }
        });
        selectElem.value = currentVal;
    }

    // ==========================================
    // --- 6. CLAIM MODAL ACTIONS ---
    // ==========================================

    function openClaimModal() {
        const modal = document.getElementById('claimModal');
        modal.querySelector('form').reset();
        document.getElementById('modal_claim_id').value = '';
        document.getElementById('div_two_pot_withdrawal_details').style.display = 'none';
        document.getElementById('email-composition-container').style.display = 'none';
        const notesTable = document.getElementById('claim_notes_tbody');
        if (notesTable) notesTable.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#777;">Save claim to add new notes.</td></tr>';
        toggleTwoPotLogic();
        togglePotVisibility();
        modal.style.display = 'block';
    }

    function editClaim(button) {
        document.getElementById('modal_claim_id').value = button.getAttribute('data-id');
        document.querySelector('input[name="id_number"]').value = button.getAttribute('data-id_number');
        document.querySelector('input[name="member_name"]').value = button.getAttribute('data-member_name');
        document.querySelector('input[name="member_surname"]').value = button.getAttribute('data-member_surname');
        
        const mipInput = document.querySelector('input[name="mip_number"]');
        if(mipInput) mipInput.value = button.getAttribute('data-mip_number') || "";

        setSelect('claim_type', button.getAttribute('data-claim_type'));
        toggleTwoPotLogic();

        setSelect('exit_reason', button.getAttribute('data-exit_reason'));
        setSelect('claim_allocation', button.getAttribute('data-claim_allocation'));
        setSelect('claim_status', button.getAttribute('data-claim_status'));
        setSelect('payment_option', button.getAttribute('data-payment_option'));
        
        document.getElementById('id_vested_pot_available').checked = (button.getAttribute('data-vested_pot_available') === 'True');
        document.getElementById('id_vested_pot_paid_date').value = button.getAttribute('data-vested_pot_paid_date') || "";
        document.getElementById('id_savings_pot_available').checked = (button.getAttribute('data-savings_pot_available') === 'True');
        document.getElementById('id_savings_pot_paid_date').value = button.getAttribute('data-savings_pot_paid_date') || "";
        document.getElementById('id_infund_cert_date').value = button.getAttribute('data-infund_cert_date') || "";
        
        togglePotVisibility();
        toggleWithdrawalSubFields(); 

        const amountInput = document.querySelector('input[name="claim_amount"]');
        if(amountInput) amountInput.value = button.getAttribute('data-claim_amount') || "";
        
        document.querySelector('input[name="claim_created_date"]').value = button.getAttribute('data-claim_created_date') || "";
        document.querySelector('input[name="last_contribution_date"]').value = button.getAttribute('data-last_contribution_date') || "";
        document.querySelector('input[name="date_submitted"]').value = button.getAttribute('data-date_submitted') || "";
        document.querySelector('input[name="date_paid"]').value = button.getAttribute('data-date_paid') || "";
        
        const emailSelect = document.getElementById('linked_email_id');
        if(emailSelect) emailSelect.value = button.getAttribute('data-linked_email_id') || ""; 
        document.getElementById('email-composition-container').style.display = 'none';

        const notesSource = document.getElementById('notes-data-' + button.getAttribute('data-id'));
        const notesTarget = document.getElementById('claim_notes_tbody');
        if (notesSource && notesTarget) notesTarget.innerHTML = notesSource.innerHTML;
        else if (notesTarget) notesTarget.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#777;">No notes available.</td></tr>';
        
        document.getElementById('claimModal').style.display = 'block';
    }

    function setSelect(name, value) {
        const select = document.querySelector(`select[name="${name}"]`);
        if (select) select.value = (!value || value === 'None') ? "" : value;
    }

    window.onclick = function(event) {
        const modals = [
            document.getElementById('emailPreviewModal'),
            document.getElementById('claimModal'),
            document.getElementById('emailViewModal')
        ];
        modals.forEach(m => {
            if (event.target == m) m.style.display = "none";
        });
    }
</script>
</body>
</html>