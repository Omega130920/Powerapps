<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORG Data Table</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration copied from the Import Data Page for a consistent theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#81c784', // Main accent, header text
                        'hover-green': '#66bb6a',  // Hover state
                        'container-light': '#f0fff0', // Main content box background (Honeydew) 
                        'bg-top': '#d1e2c4', // Body background
                        'accent-border': '#c3e6cb', // Borders
                        'dark-title': '#1b5e20', // Dark green title color
                    }
                }
            }
        }
        // Removed the client-side filterTable() function as filtering is now handled by Django

        // New JavaScript function to handle row click navigation
        function navigateToOrgDetail(levyNumber) {
            // Assumes the Django URL pattern name is 'org_table_info'
            window.location.href = `/org/table/info/${levyNumber}/`;
        }
        
        // Function to submit the main form when a filter changes
        document.addEventListener('DOMContentLoaded', function() {
            const filterForm = document.getElementById('org-search-form');
            const filterSelectors = document.querySelectorAll('.filter-select');

            filterSelectors.forEach(select => {
                select.addEventListener('change', () => {
                    filterForm.submit();
                });
            });
        });
    </script>
    <style>
        body {
            font-family: sans-serif;
            background: linear-gradient(to bottom, #d1e2c4, #d1e2c4);
            margin: 20px;
            color: #333;
            line-height: 1.6;
        }
        
        h1 {
            color: #1b5e20;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .container {
            width: 100%;
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
        }
        
        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .return-button {
            display: inline-block; 
            padding: 10px 20px;
            background-color: #43a047; /* Darker green for a strong button */
            border: 1px solid #43a047; 
            border-radius: 5px;
            text-decoration: none; 
            color: white; 
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: bold;
        }
        .return-button:hover { 
            background-color: #388e3c; 
            border-color: #388e3c;
        }

        .search-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-form button {
            padding: 8px 12px;
            background-color: #43a047;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .search-form button:hover {
            background-color: #388e3c;
        }

        /* ðŸ›‘ NEW: Filter bar container style ðŸ›‘ */
        .filter-bar {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            margin-bottom: 20px;
            padding: 10px 0;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            font-size: 0.9em;
        }
        
        .filter-group label {
            font-weight: bold;
            color: #43a047;
            margin-bottom: 5px;
        }
        
        .filter-select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
            background-color: white;
        }

        table {
            width: 100%; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 5px; overflow: hidden; background-color: #f0fff0;
            border: 1px solid #c3e6cb; margin-bottom: 20px; font-size: 0.9em;
        }
        thead th {
            background-color: #43a047; color: white; padding: 12px; text-align: left;
            font-weight: bold; border-bottom: 2px solid #388e3c; white-space: nowrap;
            border-right: 1px solid #388e3c;
        }
        thead th:last-child { border-right: none; }
        tbody td {
            padding: 10px 12px; border-bottom: 1px solid #aed581; border-right: 1px solid #aed581;
        }
        tbody td:last-child { border-right: none; }
        tbody tr:nth-child(even) { background-color: #e6ffe6; }
        /* Updated styles to make the row look clickable */
        tbody tr { cursor: pointer; }
        tbody tr:hover { background-color: #ccffcc; }

        /* Pagination styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #c3e6cb;
            background-color: #f0fff0;
            border-radius: 0 0 8px 8px;
        }
        .pagination-link {
            padding: 8px 15px;
            background-color: #43a047;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        .pagination-link:hover:not(.disabled) {
            background-color: #388e3c;
        }
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<!-- Body matches bankline.html for layout - REDUCED BODY PADDING -->
<body class="p-2 min-h-screen flex flex-col items-center">

    <!-- ADJUSTMENT: Changed max-w-screen-2xl to max-w-full for maximum width -->
    <div class="controls-container w-full max-w-full mx-auto mb-4 flex justify-between items-center">
        <!-- Back to Dashboard Link now uses .return-button class -->
        <a href="{% url 'dashboard' %}" class="return-button">
            &larr; Back to Home Screen
        </a>
        
        <!-- Search Form (Levy # or Name wildcard search) -->
        <form method="GET" class="search-form" action="{% url 'org_table_view' %}" id="org-search-form">
            <div class="relative">
                <input type="text" name="search_query" placeholder="Search Levy # or Name..." 
                    value="{{ search_query|default:'' }}"
                    class="p-2 pl-10 border border-accent-border rounded-lg shadow-sm w-64 focus:ring-primary-green focus:border-primary-green transition duration-150 text-sm">
                
                <!-- Search Icon positioned inside the input field -->
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <!-- Hidden inputs for filter values so they persist with the search button -->
            <input type="hidden" name="due_filter" id="due-filter-hidden" value="{{ due_filter|default:'' }}">
            <input type="hidden" name="cbr_filter" id="cbr-filter-hidden" value="{{ cbr_filter|default:'' }}">
            <input type="hidden" name="agent_filter" id="agent-filter-hidden" value="{{ agent_filter|default:'' }}">
            
            <button type="submit" class="search-form button hidden sm:inline-block">Search</button>
        </form>
    </div>

    <!-- ðŸ›‘ NEW: Filter Bar for Due Amount, CBR Status, and Agent ðŸ›‘ -->
    <div class="w-full max-w-full mx-auto filter-bar bg-container-light/80 p-4 rounded-lg shadow-inner border border-accent-border flex-wrap">
        
        <!-- Due Amount Filter -->
        <div class="filter-group">
            <label for="due_filter_select">Due Amount</label>
            <select name="due_filter" id="due_filter_select" class="filter-select" form="org-search-form">
                <option value="">All Amounts</option>
                <!-- These options assume you define the range logic in your Django view -->
                <option value="positive" {% if due_filter == 'positive' %}selected{% endif %}>Positive (> R0.00)</option>
                <option value="negative" {% if due_filter == 'negative' %}selected{% endif %}>Negative (< R0.00)</option>
                <option value="zero" {% if due_filter == 'zero' %}selected{% endif %}>Zero (R0.00)</option>
            </select>
        </div>

        <!-- CBR Status Filter -->
        <div class="filter-group">
            <label for="cbr_filter_select">CBR Status</label>
            <select name="cbr_filter" id="cbr_filter_select" class="filter-select" form="org-search-form">
                <option value="">All Statuses</option>
                <!-- These options should be dynamically populated from your unique Org data values -->
                {% for status in cbr_statuses %}
                <option value="{{ status }}" {% if cbr_filter == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Agent Filter (Assuming Agent field is on the Org model or related model) -->
        <div class="filter-group">
            <label for="agent_filter_select">Agent</label>
            <select name="agent_filter" id="agent_filter_select" class="filter-select" form="org-search-form">
                <option value="">All Agents</option>
                <!-- These options should be dynamically populated from your unique Org data values -->
                {% for agent in agents %}
                <option value="{{ agent }}" {% if agent_filter == agent %}selected{% endif %}>{{ agent }}</option>
                {% endfor %}
            </select>
        </div>
        
    </div>
    <!-- ðŸ›‘ END NEW FILTER BAR ðŸ›‘ -->

    <!-- ADJUSTMENT: Changed max-w-screen-2xl to max-w-full for maximum width -->
    <div class="w-full max-w-full flex-grow bg-container-light p-4 shadow-xl rounded-xl border border-accent-border flex flex-col">
        
        <!-- Header -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-dark-title mb-8 border-b border-accent-border pb-3 text-center">
            ORG Reconciliation Data
        </h1>
        
        <!-- Table Wrapper for scrolling -->
        <div class="scrollable-table-body shadow-lg rounded-lg border border-accent-border overflow-auto flex-grow">
            
            <table class="min-w-full divide-y divide-accent-border"> 
                <thead class="bg-primary-green/80 sticky top-0 z-10">
                    <tr>
                        <!-- Hardcoded and Condensed Headers -->
                        <th scope="col" class="table-cell text-left text-xs font-semibold uppercase tracking-wider text-white">Levy</th>
                        <th scope="col" class="table-cell text-left text-xs font-semibold uppercase tracking-wider text-white">Levy Name</th>
                        <th scope="col" class="table-cell text-left text-xs font-semibold uppercase tracking-wider text-white">Billing Period</th>
                        <th scope="col" class="table-cell text-right text-xs font-semibold uppercase tracking-wider text-white">Due Amount</th>
                        <th scope="col" class="table-cell text-left text-xs font-semibold uppercase tracking-wider text-white">CBR Status</th>
                        <th scope="col" class="table-cell text-right text-xs font-semibold uppercase tracking-wider text-white">Overs/Unders</th>
                        <th scope="col" class="table-cell text-right text-xs font-semibold uppercase tracking-wider text-white">Agent</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-accent-border/50 bg-white">
                    <!-- CHANGED: Iterates over the paginated page object -->
                    {% for row in org_data_page %}
                    
                    <!-- MODIFICATION: Added onclick to the row (tr) -->
                    <tr class="hover:bg-primary-green/10 transition duration-150 cursor-pointer"
                        onclick="navigateToOrgDetail('{{ row.levy_number }}')"> 
                        
                        <!-- Levy Number is now plain text -->
                        <td class="table-cell text-gray-700 font-semibold">
                            {{ row.levy_number }}
                        </td>
                        
                        <!-- Data rows (left-aligned) -->
                        <td class="table-cell text-gray-700">{{ row.employer_name }}</td>
                        <td class="table-cell text-gray-700">{{ row.billing_period }}</td>
                        
                        <!-- Monetary Fields: Keep whitespace-nowrap and align right -->
                        <td class="table-cell text-gray-700 text-right font-mono">R{{ row.due_amount|floatformat:2 }}</td>
                        
                        <!-- CBR Status (left-aligned) -->
                        <td class="table-cell text-gray-700">{{ row.cbr_status }}</td>
                        
                        <!-- Overs/Unders (right-aligned) -->
                        <td class="table-cell text-gray-700 text-right font-mono">R{{ row.overs_unders|floatformat:2 }}</td>
                        
                        <!-- Agent (left-aligned) -->
                        <td class="table-cell text-gray-700">{{ row.agent|default:"N/A" }}</td>

                    </tr>
                    {% empty %}
                    <tr>
                        <!-- Updated colspan to 7 to match the current visible column count -->
                        <td colspan="7" class="table-cell text-center py-4 text-gray-500 italic">
                            No ORG data found for the current page.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        {% if org_data_page.has_other_pages %}
        <div class="pagination-container rounded-t-none">
            
            <!-- Previous Button: Now includes search_query persistence -->
            {% if org_data_page.has_previous %}
                <a href="?page={{ org_data_page.previous_page_number }}{% if search_query %}&search_query={{ search_query }}{% endif %}{% if due_filter %}&due_filter={{ due_filter }}{% endif %}{% if cbr_filter %}&cbr_filter={{ cbr_filter }}{% endif %}{% if agent_filter %}&agent_filter={{ agent_filter }}{% endif %}" 
                    class="pagination-link">
                    &larr; Previous
                </a>
            {% else %}
                <span class="pagination-link disabled">&larr; Previous</span>
            {% endif %}
            
            <!-- Page Status -->
            <span class="text-sm font-semibold text-gray-700">
                Page {{ org_data_page.number }} of {{ org_data_page.paginator.num_pages }}
                (Total Records: {{ org_data_page.paginator.count }})
            </span>
            
            <!-- Next Button: Now includes search_query persistence -->
            {% if org_data_page.has_next %}
                <a href="?page={{ org_data_page.next_page_number }}{% if search_query %}&search_query={{ search_query }}{% endif %}{% if due_filter %}&due_filter={{ due_filter }}{% endif %}{% if cbr_filter %}&cbr_filter={{ cbr_filter }}{% endif %}{% if agent_filter %}&agent_filter={{ agent_filter }}{% endif %}" 
                    class="pagination-link">
                    Next &rarr;
                </a>
            {% else %}
                <span class="pagination-link disabled">Next &rarr;</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- Footer / Back Button (Added a consistent back button) -->
        <div class="mt-8 text-center flex-shrink-0">
            <a href="javascript:history.back()" 
                class="inline-block py-2 px-6 border border-transparent rounded-lg shadow-md text-sm font-semibold text-white 
                        bg-primary-green hover:bg-hover-green transition duration-200 
                        focus:outline-none focus:ring-4 focus:ring-primary-green focus:ring-opacity-50">
                &larr; Back to Previous Page
            </a>
        </div>
    </div>
</body>
</html>
